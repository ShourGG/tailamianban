# 泰拉瑞亚面板项目 - 开发协作规范

> 📅 创建日期：2025-10-01  
> 🎯 目的：确保 AI 助手和开发者之间的高效协作

---

## 🚨 核心原则（必须遵守）

### 1. 版本管理铁律

**规则：每次代码修改（无论大小）都必须：**

```bash
1. 更新版本号（补丁号 +1）
   - 位置：web/package.json 的 "version" 字段
   - 格式：主版本.次版本.修订号.补丁号
   - 示例：1.1.9.9 → 1.1.9.10

2. 提交到 Git 并打标签
   git add .
   git commit -m "类型(模块): v版本号 - 简短描述"
   git tag v版本号
   
3. 推送到 GitHub（两步骤）
   git push origin main
   git push origin v版本号  # ⚠️ 必须单独推送标签
```

**⚠️ 特别注意：**
- 标签推送必须**单独执行**，不能在一条命令中完成
- 只有推送标签后，GitHub Actions 才会创建完整的 Release 包
- 版本号必须与 `package.json` 保持一致

---

## 📋 版本号管理策略

### 语义化版本：`主版本.次版本.修订号.补丁号`

| 位数 | 含义 | 何时增加 | 示例 |
|------|------|----------|------|
| **第1位** | 主版本 | 重大架构变更、不兼容更新 | 1.x.x.x → 2.0.0.0 |
| **第2位** | 次版本 | 新功能添加、功能模块变更 | 1.1.x.x → 1.2.0.0 |
| **第3位** | 修订号 | Bug 修复、功能改进 | 1.1.9.x → 1.1.10.0 |
| **第4位** | 补丁号 | 紧急修复、微调、日常维护 | 1.1.9.9 → 1.1.9.10 |

### 实际应用场景

```bash
# ❌ 不需要改版本号
- 代码注释修改
- 纯文档更新（README.md）
- 配置文件调整（不影响功能）

# ✅ 需要改版本号
- 修复 UI bug（补丁号 +1）
- 添加新功能模块（次版本 +1）
- 修复安全漏洞（修订号 +1）
- 架构重构（主版本 +1）
```

---

## 🔧 技术架构关键信息

### 项目结构

```
泰拉瑞亚面板/
├── cmd/                    # Go 后端入口
│   └── main.go
├── internal/               # Go 内部包
│   ├── api/               # API 路由和处理器
│   ├── service/           # 业务逻辑层
│   └── repository/        # 数据访问层
├── web/                   # Vue3 前端
│   ├── src/
│   │   ├── views/         # 页面组件
│   │   ├── components/    # 通用组件
│   │   ├── api/           # API 调用
│   │   └── config/        # 配置文件
│   │       └── version.ts # 版本号配置（自动生成）
│   ├── scripts/
│   │   └── sync-version.js # 版本同步脚本
│   └── package.json       # 版本号源头（唯一真相）
├── scripts/               # 部署脚本
│   ├── install.sh         # 一键安装脚本
│   └── run.sh            # 启动脚本
└── .github/workflows/     # GitHub Actions CI/CD
    └── release.yml        # 自动构建配置
```

### 技术栈

**后端：**
- Go 1.23 + Gin + SQLite
- GORM（ORM）
- WebSocket 实时通信

**前端：**
- Vue 3 + TypeScript + Vite
- Naive UI（组件库）
- Pinia（状态管理）

---

## 🎯 登录页面技术要点

### 已知问题和解决方案

#### 问题1：动态组件 `C_Form` 无法渲染

**现象：** 登录页面不显示用户名和密码输入框

**根本原因：**
- `C_Form` 组件依赖复杂的动态渲染机制
- 表单配置结构不完整

**解决方案：**
```typescript
// ❌ 不使用 C_Form
<C_Form :form-items="formItems" />

// ✅ 直接使用 Naive UI 原生组件
<NForm ref="formRef" :model="formModel" :rules="formRules">
  <NFormItem label="用户名" path="username">
    <NInput v-model:value="formModel.username" />
  </NFormItem>
</NForm>
```

#### 问题2：表单实例未准备好

**现象：** 点击登录按钮报错 "表单实例未准备好"

**根本原因：**
- Vue 组件挂载时序问题
- `formRef` 在 DOM 渲染前被访问

**解决方案：**
```typescript
// 1. 明确类型和初始值
const formRef = ref<any>(null)
const formReady = ref(false)

// 2. 使用生命周期钩子
onMounted(() => {
  nextTick(() => {
    formReady.value = true
  })
})

// 3. 检查表单就绪状态
const handleDirectLogin = (): void => {
  if (!formReady.value || !formRef.value) {
    message.warning('表单正在初始化，请稍候...')
    return
  }
  // ... 登录逻辑
}
```

#### 问题3：Vite 构建时无法解析 `package.json`

**现象：** `Could not resolve "../../package.json"`

**根本原因：**
- Vite/Rollup 不允许在客户端代码中直接导入 JSON 文件

**解决方案：**
```typescript
// ❌ 直接导入（构建失败）
import packageJson from '../../package.json'

// ✅ 使用中间层配置文件
// 1. 创建 web/src/config/version.ts
export const VERSION = '1.1.9.10'

// 2. 创建 web/scripts/sync-version.js
// 从 package.json 读取并生成 version.ts

// 3. 配置 prebuild hook
"scripts": {
  "prebuild": "node scripts/sync-version.js",
  "build": "env-manager prod && vite build"
}
```

---

## 🚀 GitHub Actions 工作流程

### 触发条件

```yaml
on:
  push:
    branches:
      - main        # ✅ 推送代码 → 触发构建
    tags:
      - 'v*'        # ✅ 推送标签 → 触发构建 + 创建 Release
```

### 构建阶段

1. **前端构建** (~2-3分钟)
   ```bash
   cd web
   npm ci --legacy-peer-deps
   npm run build  # 自动运行 sync-version.js
   ```

2. **后端构建** (~3-5分钟)
   - 编译 Linux AMD64 版本
   - 编译 Linux ARM64 版本
   - 嵌入前端资源到二进制文件
   - 注入版本号

3. **创建发布** (~1分钟)
   - 打包为 `.tar.gz`
   - 创建 GitHub Release
   - 上传构建产物

### 查看构建状态

```
https://github.com/ShourGG/tailamianban/actions
```

---

## 📝 提交信息规范

### 格式

```
类型(模块): v版本号 - 简短描述

详细说明（可选）:
- 变更点1
- 变更点2
```

### 类型说明

| 类型 | 说明 | 示例 |
|------|------|------|
| `feat` | 新功能 | `feat(player): v1.2.0.0 - 添加玩家管理模块` |
| `fix` | Bug修复 | `fix(login): v1.1.9.10 - 修复表单实例未准备好的错误` |
| `refactor` | 重构 | `refactor(api): v1.3.0.0 - 重构 API 路由结构` |
| `perf` | 性能优化 | `perf(database): v1.1.10.0 - 优化数据库查询性能` |
| `style` | 样式调整 | `style(login): v1.1.9.11 - 优化登录页面动画` |
| `docs` | 文档更新 | `docs: 更新 README` |
| `chore` | 构建/工具 | `chore: bump version to v1.1.9.10` |

---

## 🔄 标准开发流程

### 完整流程示例

```bash
# 1. 修改代码
vi web/src/views/login/index.vue

# 2. 更新版本号
vi web/package.json
# 修改 "version": "1.1.9.11"

# 3. 提交代码
git add .
git commit -m "fix(login): v1.1.9.11 - 修复验证码刷新问题

- 修复验证码组件重置逻辑
- 添加错误重试机制
- 优化用户体验"

# 4. 创建标签
git tag v1.1.9.11

# 5. 推送（分两步）
git push origin main
git push origin v1.1.9.11

# 6. 验证构建
# 访问 https://github.com/ShourGG/tailamianban/actions
# 等待约 5-8 分钟
```

---

## ⚠️ 常见错误和避免方法

### 错误1：标签未推送

**症状：** GitHub Actions 只构建不发布

**原因：** 忘记推送标签或标签推送失败

**解决：**
```bash
# 检查本地标签
git tag -l "v1.1.9.10"

# 补推标签
git push origin v1.1.9.10
```

### 错误2：版本号不一致

**症状：** 前端显示的版本号与 `package.json` 不一致

**原因：** 没有运行 `sync-version.js` 或者本地开发时缓存

**解决：**
```bash
# 手动同步版本号
cd web
node scripts/sync-version.js

# 清除缓存并重新构建
npm run build
```

### 错误3：构建失败

**常见原因：**
1. 依赖安装失败 → 检查 `package.json` 语法
2. 类型错误 → 运行 `npm run type-check`
3. 测试失败 → 运行 `npm run test:unit`

---

## 🎯 AI 助手协作要点

### 必须遵守的规则

1. **每次修改都更新版本号**（无论多小的改动）
2. **所有代码必须使用英文**（包括变量名、注释）
3. **提交信息可以中文**（便于理解）
4. **标签必须单独推送**（不能合并命令）
5. **等待用户确认**（修改后不要自动继续）

### 工作流程检查清单

- [ ] 修改了代码文件
- [ ] 更新了 `web/package.json` 版本号
- [ ] 执行了 `git add` 和 `git commit`
- [ ] 创建了对应的 Git 标签
- [ ] 推送了代码到 main 分支
- [ ] 推送了标签到远程仓库
- [ ] 提供了 GitHub Actions 链接
- [ ] 说明了预期构建时间

---

## 📞 联系和反馈

如果发现本文档有任何不准确或需要补充的内容，请及时更新此文档。

**文档维护者：** 项目开发团队  
**最后更新：** 2025-10-01
