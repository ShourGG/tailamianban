import xe from"./index-CmtMtyJe.js";import{k as Ee,r as W,e as de,c as T,w as Le,Z as U,Q as h,S as l,R as o,U as n,P as k,X as z,a2 as ee,J as d,j as w,_,F as B,M as F,H as re,ai as se}from"./vue-vendor-DgJqRHrX.js";import{ac as Ue,a0 as Be,af as Fe,ag as Ae,K as De,$ as Oe,M as Ve,ae as $e,L as Ge,Y as Re,Z as je,ab as Ke}from"./ui-vendor-Dblj447Y.js";import{_ as Ze}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./iconify-sN5qq56k.js";import"./index-D3z4ySpN.js";import"./robot-avatar-1-CBzFR956.js";const He={permissionTypeOptions:[{label:"菜单权限",value:"menu"},{label:"按钮权限",value:"button"},{label:"接口权限",value:"api"}]},Je=()=>{const I=(p,u)=>{for(const i of p){if(i.id===u)return i;if(i.children){const b=I(i.children,u);if(b)return b}}return null},G=(p,u)=>{for(const i of p)if(i.id===u||i.children&&I(i.children,u))return i;return null},y=p=>{const u=[],i=b=>{for(const g of b)u.push(g.id),g.children&&i(g.children)};return i(p),u},N=(p,u)=>p.some(i=>[i.name,i.code,i.description||""].some(S=>S.toLowerCase().includes(u))||i.children&&N(i.children,u)),L=(p,u)=>p.some(i=>i.type===u||i.children&&L(i.children,u)),A=p=>{const u=[],i=b=>{for(const g of b)u.push(g),g.children&&i(g.children)};return p.children&&i(p.children),u},D=p=>{if(!p.children)return[];const u=p.children.filter(i=>i.type==="menu");return u.length===0?p.children:u},R={menu:"mdi:menu",button:"mdi:gesture-tap-button",api:"mdi:api"},j={menu:"info",button:"success",api:"warning"},P={menu:"菜单",button:"按钮",api:"接口"};return{findPermissionById:I,findTopLevelPermission:G,getAllPermissionIds:y,hasMatchingPermissionInTree:N,hasPermissionTypeInTree:L,getModulePermissions:A,getModuleDisplayPermissions:D,getPermissionIcon:p=>R[p]||"mdi:circle",getPermissionTypeColor:p=>j[p]||"default",getPermissionTypeName:p=>P[p]||p}},Qe={class:"permission-header"},Xe={class:"header-info"},Ye={class:"header-actions"},qe={class:"tree-permission-layout"},We={class:"permission-toolbar"},es={class:"toolbar-left"},ss={class:"toolbar-right"},ts={class:"permission-stats"},ns={class:"stat-item"},os={class:"stat-value"},is={class:"stat-item"},ls={class:"stat-value highlight"},cs={class:"stat-item"},as={class:"stat-value"},ds={class:"stat-label"},rs={class:"stat-value"},us={class:"tree-permissions-container"},ps={class:"module-header"},ms={class:"module-info"},_s={class:"module-title-section"},hs={class:"module-description"},fs={class:"module-controls"},vs={class:"module-progress"},gs={class:"progress-text"},ys={key:0,class:"permission-content"},ks=["onClick"],Cs={class:"permission-header"},ws={class:"permission-main"},bs={class:"permission-info"},zs={class:"permission-title"},Ms={class:"permission-name"},Is={class:"permission-details"},Ps={class:"permission-code"},Ts={key:0,class:"permission-description"},Ns={key:0,class:"selection-indicator"},Ss={key:0,class:"child-permissions"},xs={class:"child-permissions-grid"},Es=["onClick"],Ls={class:"child-permission-content"},Us={class:"child-permission-info"},Bs={class:"child-permission-title"},Fs={class:"child-permission-name"},As={class:"child-permission-details"},Ds={class:"child-permission-code"},Os={key:0,class:"child-permission-description"},Vs={key:0,class:"child-selection-indicator"},$s={key:0,class:"selected-preview"},Gs={class:"preview-header"},Rs={class:"preview-summary"},js=Ee({__name:"index",props:{show:{type:Boolean},role:{},permissions:{},selectedIds:{}},emits:["update:show","update:selectedIds","save","showTemplate"],setup(I,{emit:G}){const y=I,N=G,{findPermissionById:L,findTopLevelPermission:A,getAllPermissionIds:D,hasMatchingPermissionInTree:R,hasPermissionTypeInTree:j,getModulePermissions:P,getModuleDisplayPermissions:te,getPermissionIcon:K,getPermissionTypeColor:Z,getPermissionTypeName:p}=Je(),u=W(""),i=W(null),b=W(!1),g=de({}),S=de({}),ue=[["menu","菜单"],["button","按钮"],["api","接口"]],O=T({get:()=>y.show,set:s=>N("update:show",s)}),v=T({get:()=>y.selectedIds,set:s=>N("update:selectedIds",s)}),pe=T(()=>{const{permissions:s}=y,e=u.value?.toLowerCase(),t=i.value;return!e&&!t?s:s.filter(c=>{const{name:m,code:C,children:$=[]}=c;return!(e&&![m,C].some(x=>x.toLowerCase().includes(e))&&!R($,e)||t&&!j($,t))})}),me=T(()=>D(y.permissions).length),_e=T(()=>{const s=new Set;return v.value.forEach(e=>{const t=A(y.permissions,e);t&&s.add(t.id)}),s.size}),he=T(()=>{const s={menu:0,button:0,api:0};return v.value.forEach(e=>{const t=L(y.permissions,e);t?.type&&t.type in s&&s[t.type]++}),s}),H=T(()=>{const s={};return v.value.forEach(e=>{const t=L(y.permissions,e),c=A(y.permissions,e);if(t&&c){const{name:m,icon:C="mdi:folder"}=c;s[m]??(s[m]={module:m,icon:C,permissions:[]}),s[m].permissions.push(t)}}),Object.values(s)}),M=s=>v.value.includes(s),ne=s=>{if(!u.value)return!1;const e=u.value.toLowerCase();return[s.name,s.code,s.description||""].some(t=>t.toLowerCase().includes(e))},V=s=>J(s).length>0,J=s=>{const{children:e=[]}=s,t=u.value?.toLowerCase(),c=i.value;return e.filter(m=>c&&m.type!==c?!1:t?[m.name,m.code,m.description||""].some(C=>C.toLowerCase().includes(t)):!0)},fe=s=>{const{children:e=[]}=s,t=e.map(m=>m.id),c=t.filter(m=>v.value.includes(m));return c.length>0&&c.length<t.length},Q=s=>P(s).length,oe=s=>P(s).filter(e=>v.value.includes(e.id)).length,ie=s=>{const e=Q(s),t=oe(s);return e>0?Math.round(t/e*100):0},ve=s=>{const e=ie(s);return e===0?"#d9d9d9":e===100?"#52c41a":"#1890ff"},ge=s=>{const e=P(s);return e.length>0&&e.every(t=>v.value.includes(t.id))},ye=s=>{const e=P(s),t=e.filter(c=>v.value.includes(c.id)).length;return t>0&&t<e.length},le=(s,e)=>{e[s]=!e[s]},ke=s=>{b.value=s,y.permissions.forEach(({id:e,children:t=[]})=>{g[e]=s,t.forEach(c=>{c.children?.length&&(S[c.id]=s)})})},X=s=>{const e=new Set(v.value);s(e),v.value=Array.from(e)},Y=(s,e)=>{X(t=>e?t.add(s):t.delete(s))},Ce=(s,e)=>{const{id:t,children:c=[]}=s;X(m=>{e?(m.add(t),c.forEach(C=>m.add(C.id))):(m.delete(t),c.forEach(C=>m.delete(C.id)))})},we=(s,e)=>{const t=P(s);X(c=>{t.forEach(m=>e?c.add(m.id):c.delete(m.id))})},be=()=>{v.value=D(y.permissions)},ce=()=>{v.value=[]},ze=()=>{N("save",v.value)},Me=()=>{O.value=!1};return Le(()=>y.show,s=>{s&&y.permissions.length>0&&y.permissions.forEach(({id:e})=>{g[e]??(g[e]=!0)})},{immediate:!0}),(s,e)=>{const t=xe,c=Ve,m=je,C=De,$=Be,ae=Fe,x=Ae,Ie=Oe,q=$e,E=Ge,Pe=Re,Te=Ue,Ne=Ke;return h(),U(Ne,{show:d(O),"onUpdate:show":e[5]||(e[5]=a=>ee(O)?O.value=a:null),width:1200,placement:"right","mask-closable":!1},{default:l(()=>[o(Te,{closable:""},{header:l(()=>[n("div",Qe,[n("div",Xe,[o(t,{name:"mdi:shield-key-outline",size:24}),n("div",null,[e[6]||(e[6]=n("h3",null,"权限分配",-1)),n("p",null,_(I.role?.name)+" - "+_(I.role?.description||"角色权限管理"),1)])]),n("div",Ye,[o(C,null,{default:l(()=>[o(m,{value:d(v).length,max:999,type:"success"},{default:l(()=>[o(c,{type:"primary",size:"large",onClick:ze},{icon:l(()=>[o(t,{name:"mdi:content-save",size:16})]),default:l(()=>[w(" 保存配置 ("+_(d(v).length)+") ",1)]),_:1})]),_:1},8,["value"]),o(c,{onClick:Me},{default:l(()=>[...e[7]||(e[7]=[w("取消",-1)])]),_:1})]),_:1})])])]),default:l(()=>[n("div",qe,[n("div",We,[n("div",es,[o($,{value:d(u),"onUpdate:value":e[0]||(e[0]=a=>ee(u)?u.value=a:null),placeholder:"搜索权限名称、编码或描述...",clearable:"",size:"large",style:{width:"350px"}},{prefix:l(()=>[o(t,{name:"mdi:magnify",size:18})]),_:1},8,["value"]),o(ae,{value:d(i),"onUpdate:value":e[1]||(e[1]=a=>ee(i)?i.value=a:null),placeholder:"权限类型",clearable:"",style:{width:"120px"},options:d(He).permissionTypeOptions},null,8,["value","options"]),o(x,{checked:d(b),"onUpdate:checked":ke},{default:l(()=>[w(_(d(b)?"收起全部":"展开全部"),1)]),_:1},8,["checked"])]),n("div",ss,[o(C,null,{default:l(()=>[o(Ie,null,{default:l(()=>[o(c,{onClick:be,type:"primary",ghost:""},{icon:l(()=>[o(t,{name:"mdi:checkbox-multiple-marked",size:16})]),default:l(()=>[e[8]||(e[8]=w(" 全选 ",-1))]),_:1}),o(c,{onClick:ce},{icon:l(()=>[o(t,{name:"mdi:checkbox-multiple-blank",size:16})]),default:l(()=>[e[9]||(e[9]=w(" 清空 ",-1))]),_:1})]),_:1}),o(c,{type:"primary",ghost:"",onClick:e[2]||(e[2]=a=>s.$emit("showTemplate"))},{icon:l(()=>[o(t,{name:"mdi:bookmark-multiple",size:16})]),default:l(()=>[e[10]||(e[10]=w(" 快速模板 ",-1))]),_:1})]),_:1})])]),n("div",ts,[o(C,{align:"center"},{default:l(()=>[n("div",ns,[e[11]||(e[11]=n("span",{class:"stat-label"},"全部权限:",-1)),n("span",os,_(d(me)),1)]),o(q,{vertical:""}),n("div",is,[e[12]||(e[12]=n("span",{class:"stat-label"},"已选权限:",-1)),n("span",ls,_(d(v).length),1)]),o(q,{vertical:""}),n("div",cs,[e[13]||(e[13]=n("span",{class:"stat-label"},"覆盖模块:",-1)),n("span",as,_(d(_e)),1)]),o(q,{vertical:""}),(h(),k(B,null,F(ue,([a,r])=>n("div",{key:a,class:"stat-item"},[n("span",ds,_(r)+"权限:",1),n("span",rs,_(d(he)[a]),1)])),64))]),_:1})]),n("div",us,[(h(!0),k(B,null,F(d(pe),a=>(h(),k("div",{key:a.id,class:"permission-module"},[n("div",ps,[n("div",ms,[n("div",_s,[o(c,{text:"",onClick:()=>le(a.id,d(g)),class:"expand-button"},{icon:l(()=>[o(t,{name:d(g)[a.id]?"mdi:chevron-down":"mdi:chevron-right",size:18},null,8,["name"])]),_:2},1032,["onClick"]),o(t,{name:a.icon||"mdi:folder",size:20},null,8,["name"]),n("h4",null,_(a.name),1),o(E,{size:"small",type:"info"},{default:l(()=>[w(_(Q(a))+" 权限 ",1)]),_:2},1024)]),n("p",hs,_(a.description||"该模块的功能权限配置"),1)]),n("div",fs,[n("div",vs,[n("span",gs,_(oe(a))+"/"+_(Q(a)),1),o(Pe,{type:"line",percentage:ie(a),height:6,"border-radius":3,"show-indicator":!1,color:ve(a)},null,8,["percentage","color"])]),o(x,{checked:ge(a),indeterminate:ye(a),"onUpdate:checked":r=>we(a,r),size:"large"},{default:l(()=>[...e[14]||(e[14]=[w(" 全选模块 ",-1)])]),_:1},8,["checked","indeterminate","onUpdate:checked"])])]),d(g)[a.id]?(h(),k("div",ys,[(h(!0),k(B,null,F(d(te)(a),r=>(h(),k("div",{key:r.id,class:"permission-tree-node"},[n("div",{class:re(["permission-card",{selected:M(r.id),highlighted:ne(r),"has-children":V(r)}]),onClick:()=>Y(r.id,!M(r.id))},[n("div",Cs,[n("div",ws,[o(x,{checked:M(r.id),indeterminate:fe(r),"onUpdate:checked":f=>Ce(r,f),onClick:e[3]||(e[3]=se(()=>{},["stop"])),size:"large"},null,8,["checked","indeterminate","onUpdate:checked"]),n("div",bs,[n("div",zs,[o(t,{name:d(K)(r.type),size:16},null,8,["name"]),n("span",Ms,_(r.name),1),o(E,{size:"tiny",type:d(Z)(r.type)},{default:l(()=>[w(_(d(p)(r.type)),1)]),_:2},1032,["type"]),V(r)?(h(),U(E,{key:0,size:"tiny",type:"info"},{default:l(()=>[w(_(J(r).length)+" 个子权限 ",1)]),_:2},1024)):z("",!0)]),n("div",Is,[n("code",Ps,_(r.code),1),r.description?(h(),k("span",Ts,_(r.description),1)):z("",!0)])])]),V(r)?(h(),U(c,{key:0,text:"",size:"small",onClick:se(()=>le(r.id,d(S)),["stop"])},{icon:l(()=>[o(t,{name:d(S)[r.id]?"mdi:chevron-down":"mdi:chevron-right",size:16},null,8,["name"])]),_:2},1032,["onClick"])):z("",!0)]),M(r.id)?(h(),k("div",Ns,[o(t,{name:"mdi:check-circle",size:18})])):z("",!0)],10,ks),V(r)&&d(S)[r.id]?(h(),k("div",Ss,[n("div",xs,[(h(!0),k(B,null,F(J(r),f=>(h(),k("div",{key:f.id,class:re(["child-permission-card",{selected:M(f.id),highlighted:ne(f),"button-type":f.type==="button","api-type":f.type==="api"}]),onClick:()=>Y(f.id,!M(f.id))},[n("div",Ls,[o(x,{checked:M(f.id),"onUpdate:checked":Se=>Y(f.id,Se),onClick:e[4]||(e[4]=se(()=>{},["stop"])),size:"medium"},null,8,["checked","onUpdate:checked"]),n("div",Us,[n("div",Bs,[o(t,{name:d(K)(f.type),size:14},null,8,["name"]),n("span",Fs,_(f.name),1),o(E,{size:"tiny",type:d(Z)(f.type)},{default:l(()=>[w(_(d(p)(f.type)),1)]),_:2},1032,["type"])]),n("div",As,[n("code",Ds,_(f.code),1),f.description?(h(),k("span",Os,_(f.description),1)):z("",!0)])])]),M(f.id)?(h(),k("div",Vs,[o(t,{name:"mdi:check",size:14})])):z("",!0)],10,Es))),128))])])):z("",!0)]))),128))])):z("",!0)]))),128))]),d(v).length>0?(h(),k("div",$s,[n("div",Gs,[e[16]||(e[16]=n("h5",null,"已选择的权限",-1)),o(c,{text:"",type:"error",onClick:ce,size:"small"},{icon:l(()=>[o(t,{name:"mdi:delete-sweep",size:16})]),default:l(()=>[e[15]||(e[15]=w(" 清空全部 ",-1))]),_:1})]),n("div",Rs,[o(C,null,{default:l(()=>[(h(!0),k(B,null,F(d(H).slice(0,6),a=>(h(),U(E,{key:a.module,type:"primary",size:"medium"},{default:l(()=>[w(_(a.module)+" ("+_(a.permissions.length)+") ",1)]),_:2},1024))),128)),d(H).length>6?(h(),U(E,{key:0,type:"default",size:"medium"},{default:l(()=>[w(" +"+_(d(H).length-6)+" 更多模块 ",1)]),_:1})):z("",!0)]),_:1})])])):z("",!0)])]),_:1})]),_:1},8,["show"])}}}),qs=Ze(js,[["__scopeId","data-v-884eb0dc"]]);export{qs as default};
