import{k as ce,G as b,r as p,c as L,w as ve,o as pe,n as C,P as N,Q as y,U as s,R as v,Z as fe,S as d,j as g,J as c,a2 as D,l as me,v as ge,L as ye,F as U,M as W,H as A,_ as h,T as we,p as Z}from"./vue-vendor-DgJqRHrX.js";import{_ as Ne}from"./charts-vendor-DjXuxi75.js";import{I as H,N as he,_ as ke,F as xe,E as _e,g as M,a as Ee}from"./NodeConfigModal.vue_vue_type_script_setup_true_lang-C_spMMM8.js";import Ce from"./StartNode-BdRGzhxV.js";import Ie from"./ApprovalNode-BRgTANNr.js";import Te from"./CopyNode-Bijohw2t.js";import Se from"./ConditionNode-B16qOaTe.js";import{H as be,M as De,ab as ze,ac as Ve}from"./ui-vendor-Dblj447Y.js";import{_ as $e}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ae={class:"approval-workflow-container"},Me={class:"floating-toolbar"},Oe={class:"add-menu-content"},Re=["onClick"],Pe={class:"menu-text"},Be={key:0,class:"validation-success"},Fe={key:1,class:"validation-errors"},Le={class:"error-summary"},Ue={class:"error-list"},We={class:"error-header"},Ze={class:"error-number"},He={class:"error-info"},Ye={class:"error-node"},je={class:"error-field"},qe={class:"error-message"},Ge={class:"error-actions"},Je={class:"validation-footer"},Qe=ce({__name:"index",props:{users:{default:()=>[]},roles:{default:()=>[]},departments:{default:()=>[]},modelValue:{},readonly:{type:Boolean,default:!1},theme:{default:"light"}},emits:["update:modelValue","change","node-click","edge-click","save","validate-error"],setup(z,{expose:Y,emit:j}){const q={start:b(Ce),approval:b(Ie),copy:b(Te),condition:b(Se)},G=z,x=j,u=be(),f=p(),a=p([{...H}]),r=p([]),I=p(!1),V=p({x:0,y:0}),w=p(!1),k=p(null),_=p([]),m=p(!1),T=p(null),J=L(()=>q),Q=L(()=>{const t={totalNodes:a.value.length,approvalNodes:0,copyNodes:0,conditionNodes:0};return a.value.forEach(e=>{e.type==="approval"?t.approvalNodes++:e.type==="copy"?t.copyNodes++:e.type==="condition"&&t.conditionNodes++}),t}),X=(t,e)=>{try{V.value={x:typeof t.x=="number"?t.x:0,y:typeof t.y=="number"?t.y:0},T.value=e||null,I.value=!0}catch{}},O=t=>{if(t==="start-1"){u?.warning?.("ä¸èƒ½åˆ é™¤å¼€å§‹èŠ‚ç‚¹");return}const e=a.value.findIndex(l=>l.id===t);if(e===-1)return;const o=r.value.filter(l=>l.target===t),i=r.value.filter(l=>l.source===t);a.value.splice(e,1),r.value=r.value.filter(l=>l.source!==t&&l.target!==t),o.forEach(l=>{i.forEach(n=>{r.value.push({id:M(l.source,n.target),source:l.source,target:n.target,animated:!0,type:"default"})})}),a.value.forEach((l,n)=>{n>=e&&(l.position.y-=120)}),S(),u?.success?.("èŠ‚ç‚¹å·²åˆ é™¤"),C(()=>{setTimeout(()=>{f.value?.fitView?.({padding:60,duration:400})},100)})};Z("showAddMenu",X),Z("deleteNode",O);const K=()=>{let t=a.value.length-1,e=a.value[t];if(T.value){const o=a.value.findIndex(i=>i.id===T.value);o!==-1&&(t=o,e=a.value[t])}return{targetNodeIndex:t,targetNode:e}},ee=(t,e)=>({id:`${t}-${Date.now()}`,type:t,position:{x:e?.position.x||150,y:(e?.position.y||130)+120},data:{title:Ee[t],status:"pending",...t==="approval"&&{approvers:[],approvalMode:"any"},...t==="copy"&&{copyUsers:[]},...t==="condition"&&{conditions:[]}}}),te=(t,e)=>{const o=r.value.filter(i=>i.source===t.id);r.value=r.value.filter(i=>i.source!==t.id),r.value.push({id:M(t.id,e.id),source:t.id,target:e.id,animated:!0,type:"default"}),o.forEach(i=>{r.value.push({id:M(e.id,i.target),source:e.id,target:i.target,animated:!0,type:"default"})})},oe=t=>{try{const{targetNodeIndex:e,targetNode:o}=K(),i=ee(t,o);a.value.splice(e+1,0,i);for(let l=e+2;l<a.value.length;l++)a.value[l].position.y+=120;o&&te(o,i),I.value=!1,T.value=null,S(),C(()=>{setTimeout(()=>{f.value?.fitView?.({padding:60,duration:400})},100)})}catch{u?.error?.("æ·»åŠ èŠ‚ç‚¹å¤±è´¥ï¼Œè¯·é‡è¯•")}},se=t=>{try{const e=t.node;k.value=e,w.value=!0,x("node-click",e)}catch{}},ne=()=>{I.value=!1},ae=t=>{if(k.value){const e=a.value.findIndex(o=>o.id===k.value.id);if(e!==-1){const o={...a.value[e],data:{...a.value[e].data,...t}};a.value.splice(e,1,o),k.value=o}S(),w.value=!1,u?.success?.("èŠ‚ç‚¹é…ç½®å·²ä¿å­˜")}},R=()=>{const t=$();if(t.length>0){u?.error?.(`å·¥ä½œæµéªŒè¯å¤±è´¥: ${t[0].message}`),m.value=!0;return}const e=E();x("save",e),u?.success?.("å·¥ä½œæµä¿å­˜æˆåŠŸ")},P=()=>{E(),u?.info?.("é¢„è§ˆåŠŸèƒ½å¼€å‘ä¸­...")},B=()=>{const t=$();_.value=t,t.length===0?(u?.success?.("âœ… å·¥ä½œæµéªŒè¯é€šè¿‡ï¼æ‰€æœ‰èŠ‚ç‚¹é…ç½®æ­£ç¡®"),m.value=!1):(u?.error?.(`âŒ å‘ç° ${t.length} ä¸ªé—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†é”™è¯¯`),m.value=!0,x("validate-error",t))},le=()=>{try{f.value?.fitView?(C(()=>{f.value.fitView({padding:50,includeHiddenNodes:!1,minZoom:.5,maxZoom:1.5,duration:800})}),u?.success?.("å·²é€‚åº”çª—å£å¤§å°")):u?.warning?.("ç”»å¸ƒæœªå‡†å¤‡å°±ç»ªï¼Œè¯·ç¨åé‡è¯•")}catch{u?.error?.("é€‚åº”çª—å£å¤±è´¥")}},ie=()=>{a.value=[{...H}],r.value=[],_.value=[],m.value=!1,S(),C(()=>{setTimeout(()=>{f.value?.fitView?.({padding:80,duration:600})},100)}),u?.success?.("ç”»å¸ƒå·²æ¸…ç©º")},$=()=>{const t=[];a.value.forEach(o=>{if(o.type==="approval"&&(o.data.approvers||[]).length===0&&t.push({nodeId:o.id,nodeName:o.data.title,field:"approvers",message:"å®¡æ‰¹èŠ‚ç‚¹å¿…é¡»è®¾ç½®è‡³å°‘ä¸€ä¸ªå®¡æ‰¹äººï¼Œå¦åˆ™æµç¨‹æ— æ³•æ­£å¸¸è¿è¡Œ",type:"required"}),o.type==="condition"){const i=o.data.conditions||[];if(i.length===0)t.push({nodeId:o.id,nodeName:o.data.title,field:"conditions",message:"æ¡ä»¶åˆ†æ”¯èŠ‚ç‚¹å¿…é¡»é…ç½®è‡³å°‘ä¸€ä¸ªåˆ†æ”¯æ¡ä»¶ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œæ¡ä»¶åˆ¤æ–­",type:"required"});else{const l=i.filter(n=>!n.name||!n.field||!n.operator||!n.value);l.length>0&&t.push({nodeId:o.id,nodeName:o.data.title,field:"conditions",message:`æœ‰ ${l.length} ä¸ªæ¡ä»¶åˆ†æ”¯é…ç½®ä¸å®Œæ•´ï¼Œè¯·å®Œå–„æ‰€æœ‰å¿…å¡«å­—æ®µ`,type:"incomplete"})}}});const e=new Set;return r.value.forEach(o=>{e.add(o.source),e.add(o.target)}),a.value.forEach(o=>{o.type!=="start"&&!e.has(o.id)&&t.push({nodeId:o.id,nodeName:o.data.title,field:"connection",message:"æ­¤èŠ‚ç‚¹æœªä¸å…¶ä»–èŠ‚ç‚¹è¿æ¥ï¼Œå¯èƒ½å¯¼è‡´æµç¨‹ä¸­æ–­",type:"warning"})}),t},re=t=>xe[t]||t,de=t=>_e[t]||t,ue=t=>{const e=a.value.find(o=>o.id===t);e&&f.value&&(f.value.setCenter(e.position.x,e.position.y,{zoom:1.2,duration:800}),setTimeout(()=>{k.value=e,w.value=!0,m.value=!1},900),u?.info?.(`å·²å®šä½åˆ°èŠ‚ç‚¹ï¼š${e.data.title}`))},E=()=>({nodes:a.value,edges:r.value,config:{version:"1.0",createdAt:new Date().toISOString()}}),S=()=>{const t=E();x("update:modelValue",t),x("change",t)};return ve(()=>G.modelValue,t=>{t&&t!==E()&&(a.value=t.nodes||[],r.value=t.edges||[])},{deep:!0}),pe(()=>{C(()=>{setTimeout(()=>{f.value?.fitView?.({padding:80,includeHiddenNodes:!1,minZoom:.8,maxZoom:1.2,duration:600})},300)})}),Y({validateWorkflow:$,getCurrentWorkflowData:E,saveWorkflow:R,previewWorkflow:P,deleteNode:O,stats:Q}),(t,e)=>{const o=De,i=Ve,l=ze;return y(),N("div",Ae,[s("div",Me,[v(o,{size:"small",type:"primary",onClick:R},{icon:d(()=>[...e[6]||(e[6]=[s("div",{class:"i-mdi:content-save w-4 h-4"},null,-1)])]),default:d(()=>[e[7]||(e[7]=g(" ä¿å­˜ ",-1))]),_:1}),v(o,{size:"small",onClick:P},{icon:d(()=>[...e[8]||(e[8]=[s("div",{class:"i-mdi:eye w-4 h-4"},null,-1)])]),default:d(()=>[e[9]||(e[9]=g(" é¢„è§ˆ ",-1))]),_:1}),v(o,{size:"small",onClick:B,title:"æ£€æŸ¥å·¥ä½œæµé…ç½®æ˜¯å¦æ­£ç¡®"},{icon:d(()=>[...e[10]||(e[10]=[s("div",{class:"i-mdi:check-circle w-4 h-4"},null,-1)])]),default:d(()=>[e[11]||(e[11]=g(" éªŒè¯æµç¨‹ ",-1))]),_:1}),e[14]||(e[14]=s("div",{class:"toolbar-divider"},null,-1)),v(o,{size:"small",onClick:le,title:"é€‚åº”çª—å£"},{icon:d(()=>[...e[12]||(e[12]=[s("div",{class:"i-mdi:fit-to-screen w-4 h-4"},null,-1)])]),_:1}),v(o,{size:"small",type:"error",onClick:ie,title:"æ¸…ç©ºç”»å¸ƒ"},{icon:d(()=>[...e[13]||(e[13]=[s("div",{class:"i-mdi:delete-sweep w-4 h-4"},null,-1)])]),_:1})]),v(c(Ne),{ref_key:"vueFlowRef",ref:f,nodes:c(a),"onUpdate:nodes":e[0]||(e[0]=n=>D(a)?a.value=n:null),edges:c(r),"onUpdate:edges":e[1]||(e[1]=n=>D(r)?r.value=n:null),"node-types":c(J),class:"workflow-canvas","default-viewport":{zoom:1,x:0,y:0},"min-zoom":.5,"max-zoom":2,"fit-view-on-init":!0,"nodes-draggable":!0,"elements-selectable":!0,onNodeClick:se,onPaneClick:ne},null,8,["nodes","edges","node-types"]),(y(),fe(we,{to:"body"},[me(s("div",{class:"add-node-menu",style:ye({left:c(V).x+"px",top:c(V).y+"px"})},[s("div",Oe,[(y(!0),N(U,null,W(c(he),n=>(y(),N("div",{key:n.type,class:"add-menu-item",onClick:F=>oe(n.type)},[s("div",{class:A(["menu-icon",n.iconClass])},[s("div",{class:A(n.icon)},null,2)],2),s("span",Pe,h(n.label),1)],8,Re))),128))])],4),[[ge,c(I)]])])),v(ke,{show:c(w),"onUpdate:show":e[2]||(e[2]=n=>D(w)?w.value=n:null),"current-node":c(k),users:z.users,departments:z.departments,onSave:ae,onCancel:e[3]||(e[3]=n=>w.value=!1)},null,8,["show","current-node","users","departments"]),v(l,{show:c(m),"onUpdate:show":e[5]||(e[5]=n=>D(m)?m.value=n:null),width:450,placement:"right"},{default:d(()=>[v(i,{title:"æµç¨‹éªŒè¯ç»“æœ",closable:""},{footer:d(()=>[s("div",Je,[v(o,{onClick:e[4]||(e[4]=n=>m.value=!1)},{default:d(()=>[...e[21]||(e[21]=[g("å…³é—­",-1)])]),_:1}),v(o,{type:"primary",onClick:B},{icon:d(()=>[...e[22]||(e[22]=[s("div",{class:"i-mdi:refresh w-4 h-4"},null,-1)])]),default:d(()=>[e[23]||(e[23]=g(" é‡æ–°éªŒè¯ ",-1))]),_:1})])]),default:d(()=>[c(_).length===0?(y(),N("div",Be,[...e[15]||(e[15]=[s("div",{class:"success-icon"},[s("div",{class:"i-mdi:check-circle text-32px text-green-500"})],-1),s("h3",null,"âœ… éªŒè¯é€šè¿‡",-1),s("p",null,"å·¥ä½œæµé…ç½®æ­£ç¡®ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½å·²æ­£ç¡®è®¾ç½®ï¼",-1)])])):(y(),N("div",Fe,[s("div",Le,[e[16]||(e[16]=s("div",{class:"error-icon"},[s("div",{class:"i-mdi:alert-circle text-24px text-red-500"})],-1)),s("h3",null,"âŒ å‘ç° "+h(c(_).length)+" ä¸ªé—®é¢˜",1),e[17]||(e[17]=s("p",null,"è¯·ä¿®å¤ä»¥ä¸‹é—®é¢˜åé‡æ–°éªŒè¯ï¼š",-1))]),s("div",Ue,[(y(!0),N(U,null,W(c(_),(n,F)=>(y(),N("div",{key:n.nodeId,class:"error-item"},[s("div",We,[s("span",Ze,h(F+1),1),s("div",He,[s("strong",Ye,h(n.nodeName),1),s("span",je,h(re(n.field)),1)]),s("div",{class:A(["error-type",n.type])},h(de(n.type)),3)]),s("div",qe,h(n.message),1),s("div",Ge,[v(o,{size:"small",type:"primary",onClick:Xe=>ue(n.nodeId)},{icon:d(()=>[...e[18]||(e[18]=[s("div",{class:"i-mdi:target w-4 h-4"},null,-1)])]),default:d(()=>[e[19]||(e[19]=g(" å®šä½èŠ‚ç‚¹ ",-1))]),_:1},8,["onClick"])])]))),128))]),e[20]||(e[20]=s("div",{class:"validation-tips"},[s("h4",null,"ğŸ’¡ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼š"),s("ul",null,[s("li",null,[s("strong",null,"å®¡æ‰¹äººæœªè®¾ç½®ï¼š"),g("ç‚¹å‡»å®¡æ‰¹èŠ‚ç‚¹ï¼Œåœ¨å¼¹çª—ä¸­é€‰æ‹©å®¡æ‰¹äººå‘˜")]),s("li",null,[s("strong",null,"æ¡ä»¶åˆ†æ”¯æœªé…ç½®ï¼š"),g("ç‚¹å‡»æ¡ä»¶èŠ‚ç‚¹ï¼Œæ·»åŠ è‡³å°‘ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯")]),s("li",null,[s("strong",null,"èŠ‚ç‚¹è¿æ¥æ–­å¼€ï¼š"),g(" æ£€æŸ¥èŠ‚ç‚¹ä¹‹é—´çš„è¿çº¿æ˜¯å¦æ­£ç¡®")])])],-1))]))]),_:1})]),_:1},8,["show"])])}}}),rt=$e(Qe,[["__scopeId","data-v-b02fbf3b"]]);export{rt as default};
