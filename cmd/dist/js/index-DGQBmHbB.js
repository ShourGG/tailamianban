import{k as ce,G as D,r as p,c as F,w as ve,o as pe,n as C,O as N,P as y,S as s,Q as v,Z as fe,R as d,j as g,J as c,a2 as b,l as me,v as ge,F as L,W as U,H as A,_ as h,L as ye,T as we,p as Z}from"./vue-vendor-DIhTWhib.js";import{_ as Ne}from"./charts-vendor-XI8Sg87J.js";import{I as H,N as he,_ as xe,F as ke,E as _e,g as O,a as Ee}from"./NodeConfigModal.vue_vue_type_script_setup_true_lang-R8Ilx7zg.js";import Ce from"./StartNode-DIJ4V6iE.js";import Ie from"./ApprovalNode-Br4QifEB.js";import Te from"./CopyNode-C6-lRjIS.js";import Se from"./ConditionNode-GAxyKjwd.js";import{H as De,M as be,W as ze,U as Ve}from"./ui-vendor-qucRfopV.js";import{_ as $e}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ae={class:"approval-workflow-container"},Oe={class:"floating-toolbar"},Me={class:"add-menu-content"},Re=["onClick"],Pe={class:"menu-text"},We={key:0,class:"validation-success"},Be={key:1,class:"validation-errors"},Fe={class:"error-summary"},Le={class:"error-list"},Ue={class:"error-header"},Ze={class:"error-number"},He={class:"error-info"},Ye={class:"error-node"},je={class:"error-field"},qe={class:"error-message"},Ge={class:"error-actions"},Je={class:"validation-footer"},Qe=ce({__name:"index",props:{users:{default:()=>[]},roles:{default:()=>[]},departments:{default:()=>[]},modelValue:{},readonly:{type:Boolean,default:!1},theme:{default:"light"}},emits:["update:modelValue","change","node-click","edge-click","save","validate-error"],setup(z,{expose:Y,emit:j}){const q={start:D(Ce),approval:D(Ie),copy:D(Te),condition:D(Se)},G=z,k=j,u=De(),f=p(),l=p([{...H}]),r=p([]),I=p(!1),V=p({x:0,y:0}),w=p(!1),x=p(null),_=p([]),m=p(!1),T=p(null),J=F(()=>q),Q=F(()=>{const t={totalNodes:l.value.length,approvalNodes:0,copyNodes:0,conditionNodes:0};return l.value.forEach(e=>{e.type==="approval"?t.approvalNodes++:e.type==="copy"?t.copyNodes++:e.type==="condition"&&t.conditionNodes++}),t}),X=(t,e)=>{try{V.value={x:typeof t.x=="number"?t.x:0,y:typeof t.y=="number"?t.y:0},T.value=e||null,I.value=!0}catch{}},M=t=>{if(t==="start-1"){u?.warning?.("不能删除开始节点");return}const e=l.value.findIndex(a=>a.id===t);if(e===-1)return;const o=r.value.filter(a=>a.target===t),i=r.value.filter(a=>a.source===t);l.value.splice(e,1),r.value=r.value.filter(a=>a.source!==t&&a.target!==t),o.forEach(a=>{i.forEach(n=>{r.value.push({id:O(a.source,n.target),source:a.source,target:n.target,animated:!0,type:"default"})})}),l.value.forEach((a,n)=>{n>=e&&(a.position.y-=120)}),S(),u?.success?.("节点已删除"),C(()=>{setTimeout(()=>{f.value?.fitView?.({padding:60,duration:400})},100)})};Z("showAddMenu",X),Z("deleteNode",M);const K=()=>{let t=l.value.length-1,e=l.value[t];if(T.value){const o=l.value.findIndex(i=>i.id===T.value);o!==-1&&(t=o,e=l.value[t])}return{targetNodeIndex:t,targetNode:e}},ee=(t,e)=>({id:`${t}-${Date.now()}`,type:t,position:{x:e?.position.x||150,y:(e?.position.y||130)+120},data:{title:Ee[t],status:"pending",...t==="approval"&&{approvers:[],approvalMode:"any"},...t==="copy"&&{copyUsers:[]},...t==="condition"&&{conditions:[]}}}),te=(t,e)=>{const o=r.value.filter(i=>i.source===t.id);r.value=r.value.filter(i=>i.source!==t.id),r.value.push({id:O(t.id,e.id),source:t.id,target:e.id,animated:!0,type:"default"}),o.forEach(i=>{r.value.push({id:O(e.id,i.target),source:e.id,target:i.target,animated:!0,type:"default"})})},oe=t=>{try{const{targetNodeIndex:e,targetNode:o}=K(),i=ee(t,o);l.value.splice(e+1,0,i);for(let a=e+2;a<l.value.length;a++)l.value[a].position.y+=120;o&&te(o,i),I.value=!1,T.value=null,S(),C(()=>{setTimeout(()=>{f.value?.fitView?.({padding:60,duration:400})},100)})}catch{u?.error?.("添加节点失败，请重试")}},se=t=>{try{const e=t.node;x.value=e,w.value=!0,k("node-click",e)}catch{}},ne=()=>{I.value=!1},le=t=>{if(x.value){const e=l.value.findIndex(o=>o.id===x.value.id);if(e!==-1){const o={...l.value[e],data:{...l.value[e].data,...t}};l.value.splice(e,1,o),x.value=o}S(),w.value=!1,u?.success?.("节点配置已保存")}},R=()=>{const t=$();if(t.length>0){u?.error?.(`工作流验证失败: ${t[0].message}`),m.value=!0;return}const e=E();k("save",e),u?.success?.("工作流保存成功")},P=()=>{E(),u?.info?.("预览功能开发中...")},W=()=>{const t=$();_.value=t,t.length===0?(u?.success?.("✅ 工作流验证通过！所有节点配置正确"),m.value=!1):(u?.error?.(`❌ 发现 ${t.length} 个问题，请查看详细错误`),m.value=!0,k("validate-error",t))},ae=()=>{try{f.value?.fitView?(C(()=>{f.value.fitView({padding:50,includeHiddenNodes:!1,minZoom:.5,maxZoom:1.5,duration:800})}),u?.success?.("已适应窗口大小")):u?.warning?.("画布未准备就绪，请稍后重试")}catch{u?.error?.("适应窗口失败")}},ie=()=>{l.value=[{...H}],r.value=[],_.value=[],m.value=!1,S(),C(()=>{setTimeout(()=>{f.value?.fitView?.({padding:80,duration:600})},100)}),u?.success?.("画布已清空")},$=()=>{const t=[];l.value.forEach(o=>{if(o.type==="approval"&&(o.data.approvers||[]).length===0&&t.push({nodeId:o.id,nodeName:o.data.title,field:"approvers",message:"审批节点必须设置至少一个审批人，否则流程无法正常运行",type:"required"}),o.type==="condition"){const i=o.data.conditions||[];if(i.length===0)t.push({nodeId:o.id,nodeName:o.data.title,field:"conditions",message:"条件分支节点必须配置至少一个分支条件，否则无法进行条件判断",type:"required"});else{const a=i.filter(n=>!n.name||!n.field||!n.operator||!n.value);a.length>0&&t.push({nodeId:o.id,nodeName:o.data.title,field:"conditions",message:`有 ${a.length} 个条件分支配置不完整，请完善所有必填字段`,type:"incomplete"})}}});const e=new Set;return r.value.forEach(o=>{e.add(o.source),e.add(o.target)}),l.value.forEach(o=>{o.type!=="start"&&!e.has(o.id)&&t.push({nodeId:o.id,nodeName:o.data.title,field:"connection",message:"此节点未与其他节点连接，可能导致流程中断",type:"warning"})}),t},re=t=>ke[t]||t,de=t=>_e[t]||t,ue=t=>{const e=l.value.find(o=>o.id===t);e&&f.value&&(f.value.setCenter(e.position.x,e.position.y,{zoom:1.2,duration:800}),setTimeout(()=>{x.value=e,w.value=!0,m.value=!1},900),u?.info?.(`已定位到节点：${e.data.title}`))},E=()=>({nodes:l.value,edges:r.value,config:{version:"1.0",createdAt:new Date().toISOString()}}),S=()=>{const t=E();k("update:modelValue",t),k("change",t)};return ve(()=>G.modelValue,t=>{t&&t!==E()&&(l.value=t.nodes||[],r.value=t.edges||[])},{deep:!0}),pe(()=>{C(()=>{setTimeout(()=>{f.value?.fitView?.({padding:80,includeHiddenNodes:!1,minZoom:.8,maxZoom:1.2,duration:600})},300)})}),Y({validateWorkflow:$,getCurrentWorkflowData:E,saveWorkflow:R,previewWorkflow:P,deleteNode:M,stats:Q}),(t,e)=>{const o=be,i=ze,a=Ve;return y(),N("div",Ae,[s("div",Oe,[v(o,{size:"small",type:"primary",onClick:R},{icon:d(()=>[...e[6]||(e[6]=[s("div",{class:"i-mdi:content-save w-4 h-4"},null,-1)])]),default:d(()=>[e[7]||(e[7]=g(" 保存 ",-1))]),_:1}),v(o,{size:"small",onClick:P},{icon:d(()=>[...e[8]||(e[8]=[s("div",{class:"i-mdi:eye w-4 h-4"},null,-1)])]),default:d(()=>[e[9]||(e[9]=g(" 预览 ",-1))]),_:1}),v(o,{size:"small",onClick:W,title:"检查工作流配置是否正确"},{icon:d(()=>[...e[10]||(e[10]=[s("div",{class:"i-mdi:check-circle w-4 h-4"},null,-1)])]),default:d(()=>[e[11]||(e[11]=g(" 验证流程 ",-1))]),_:1}),e[14]||(e[14]=s("div",{class:"toolbar-divider"},null,-1)),v(o,{size:"small",onClick:ae,title:"适应窗口"},{icon:d(()=>[...e[12]||(e[12]=[s("div",{class:"i-mdi:fit-to-screen w-4 h-4"},null,-1)])]),_:1}),v(o,{size:"small",type:"error",onClick:ie,title:"清空画布"},{icon:d(()=>[...e[13]||(e[13]=[s("div",{class:"i-mdi:delete-sweep w-4 h-4"},null,-1)])]),_:1})]),v(c(Ne),{ref_key:"vueFlowRef",ref:f,nodes:c(l),"onUpdate:nodes":e[0]||(e[0]=n=>b(l)?l.value=n:null),edges:c(r),"onUpdate:edges":e[1]||(e[1]=n=>b(r)?r.value=n:null),"node-types":c(J),class:"workflow-canvas","default-viewport":{zoom:1,x:0,y:0},"min-zoom":.5,"max-zoom":2,"fit-view-on-init":!0,"nodes-draggable":!0,"elements-selectable":!0,onNodeClick:se,onPaneClick:ne},null,8,["nodes","edges","node-types"]),(y(),fe(we,{to:"body"},[me(s("div",{class:"add-node-menu",style:ye({left:c(V).x+"px",top:c(V).y+"px"})},[s("div",Me,[(y(!0),N(L,null,U(c(he),n=>(y(),N("div",{key:n.type,class:"add-menu-item",onClick:B=>oe(n.type)},[s("div",{class:A(["menu-icon",n.iconClass])},[s("div",{class:A(n.icon)},null,2)],2),s("span",Pe,h(n.label),1)],8,Re))),128))])],4),[[ge,c(I)]])])),v(xe,{show:c(w),"onUpdate:show":e[2]||(e[2]=n=>b(w)?w.value=n:null),"current-node":c(x),users:z.users,departments:z.departments,onSave:le,onCancel:e[3]||(e[3]=n=>w.value=!1)},null,8,["show","current-node","users","departments"]),v(a,{show:c(m),"onUpdate:show":e[5]||(e[5]=n=>b(m)?m.value=n:null),width:450,placement:"right"},{default:d(()=>[v(i,{title:"流程验证结果",closable:""},{footer:d(()=>[s("div",Je,[v(o,{onClick:e[4]||(e[4]=n=>m.value=!1)},{default:d(()=>[...e[21]||(e[21]=[g("关闭",-1)])]),_:1}),v(o,{type:"primary",onClick:W},{icon:d(()=>[...e[22]||(e[22]=[s("div",{class:"i-mdi:refresh w-4 h-4"},null,-1)])]),default:d(()=>[e[23]||(e[23]=g(" 重新验证 ",-1))]),_:1})])]),default:d(()=>[c(_).length===0?(y(),N("div",We,[...e[15]||(e[15]=[s("div",{class:"success-icon"},[s("div",{class:"i-mdi:check-circle text-32px text-green-500"})],-1),s("h3",null,"✅ 验证通过",-1),s("p",null,"工作流配置正确，所有节点都已正确设置！",-1)])])):(y(),N("div",Be,[s("div",Fe,[e[16]||(e[16]=s("div",{class:"error-icon"},[s("div",{class:"i-mdi:alert-circle text-24px text-red-500"})],-1)),s("h3",null,"❌ 发现 "+h(c(_).length)+" 个问题",1),e[17]||(e[17]=s("p",null,"请修复以下问题后重新验证：",-1))]),s("div",Le,[(y(!0),N(L,null,U(c(_),(n,B)=>(y(),N("div",{key:n.nodeId,class:"error-item"},[s("div",Ue,[s("span",Ze,h(B+1),1),s("div",He,[s("strong",Ye,h(n.nodeName),1),s("span",je,h(re(n.field)),1)]),s("div",{class:A(["error-type",n.type])},h(de(n.type)),3)]),s("div",qe,h(n.message),1),s("div",Ge,[v(o,{size:"small",type:"primary",onClick:Xe=>ue(n.nodeId)},{icon:d(()=>[...e[18]||(e[18]=[s("div",{class:"i-mdi:target w-4 h-4"},null,-1)])]),default:d(()=>[e[19]||(e[19]=g(" 定位节点 ",-1))]),_:1},8,["onClick"])])]))),128))]),e[20]||(e[20]=s("div",{class:"validation-tips"},[s("h4",null,"💡 常见问题解决方案："),s("ul",null,[s("li",null,[s("strong",null,"审批人未设置："),g("点击审批节点，在弹窗中选择审批人员")]),s("li",null,[s("strong",null,"条件分支未配置："),g("点击条件节点，添加至少一个条件分支")]),s("li",null,[s("strong",null,"节点连接断开："),g(" 检查节点之间的连线是否正确")])])],-1))]))]),_:1})]),_:1},8,["show"])])}}}),rt=$e(Qe,[["__scopeId","data-v-b02fbf3b"]]);export{rt as default};
