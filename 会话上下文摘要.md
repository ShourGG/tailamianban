# 泰拉瑞亚面板项目 - 会话上下文摘要

## 📋 项目基本信息

**项目名称**: 泰拉瑞亚服务器管理面板  
**技术栈**: Go + Gin + SQLite (后端) / Vue3 + TypeScript + Naive UI (前端)  
**当前版本**: v1.1.9.11  
**GitHub 仓库**: https://github.com/ShourGG/tailamianban

---

## 🎯 核心开发规范（铁律）

### 版本管理三步走
```bash
# 1. 修改代码后更新版本号
cd web
npm version patch  # 自动更新 package.json

# 2. 提交代码
git add .
git commit -m "类型: 简短描述"

# 3. 打标签并推送（必须分两步）
git tag v1.x.x.x
git push origin main
git push origin v1.x.x.x  # 标签必须单独推送
```

**⚠️ 关键规则**：
- **每次修改代码（无论大小）都必须更新版本号**
- **标签推送必须单独执行，不能合并到一条命令**
- **版本号格式**: `主版本.次版本.修订号.补丁号`（例如：1.1.9.11）

---

## 🔧 已解决的关键问题

### 问题 1: 登录表单不显示 ✅
**症状**: 用户名和密码输入框不显示  
**原因**: 使用了动态组件 `C_Form`，但组件未正确注册  
**解决方案**:
```vue
<!-- 使用原生 Naive UI 组件 -->
<NForm ref="formRef" :model="formModel" :rules="formRules">
  <NFormItem label="用户名" path="username">
    <NInput v-model:value="formModel.username" />
  </NFormItem>
  <NFormItem label="密码" path="password">
    <NInput v-model:value="formModel.password" type="password" />
  </NFormItem>
</NForm>
```

### 问题 2: Vite 构建失败 ✅
**症状**: 构建时报错 `Cannot find module '../../package.json'`  
**原因**: Vite 不支持在客户端代码中直接 import JSON 文件  
**解决方案**:
1. 创建 `web/src/config/version.ts` 配置文件
2. 创建 `web/scripts/sync-version.js` 同步脚本
3. 在 `package.json` 中添加 `prebuild` hook 自动执行

```json
{
  "scripts": {
    "prebuild": "node scripts/sync-version.js",
    "build": "env-manager prod && vite build"
  }
}
```

### 问题 3: 表单实例未准备好 ✅
**症状**: 点击登录按钮报错 "Cannot read properties of null"  
**原因**: 表单 DOM 尚未完全渲染  
**解决方案**:
```typescript
// 添加表单就绪状态
const formReady = ref(false)

onMounted(() => {
  nextTick(() => {
    formReady.value = true
  })
})

const handleDirectLogin = (): void => {
  // 先检查表单是否准备好
  if (!formReady.value || !formRef.value) {
    message.warning('表单正在初始化，请稍候...')
    return
  }
  
  // 再执行表单验证
  formRef.value.validate((errors: any) => {
    // ...
  })
}
```

---

## 🚀 GitHub Actions 工作流程

### 触发条件
1. **推送到 main 分支** → 触发构建（不创建 Release）
2. **推送 v* 标签** → 触发构建 + 创建 Release

### 构建阶段
```
┌─────────────────┐
│ build-frontend  │  (~2-3 分钟)
│ - 安装依赖      │
│ - 构建 Vue 项目 │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│ build-backend   │  (~3-5 分钟)
│ - 编译 Go 程序  │
│ - 嵌入前端资源  │
│ - 打包发布文件  │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│ create-release  │  (~1 分钟)
│ - 生成变更日志  │  ← 只在推送标签时执行
│ - 创建 Release  │
│ - 上传安装包    │
└─────────────────┘
```

### 新增功能：自动生成更新日志 🆕
现在 Release 描述会自动分类显示提交记录：
- ✨ 新增特性 (feat/feature)
- 🐛 Bug 修复 (fix)
- ♻️ 代码重构 (refactor)
- 📝 文档更新 (docs)
- 🔧 构建/工具 (chore/build/ci)
- 🔄 其他变更

---

## 📁 关键文件路径

### 版本管理相关
- `web/package.json` - 版本号源头
- `web/src/config/version.ts` - 前端版本号配置（自动生成）
- `web/scripts/sync-version.js` - 版本号同步脚本

### 登录页面相关
- `web/src/views/login/index.vue` - 登录页面主文件
- `web/src/views/login/index.scss` - 登录页面样式
- `web/src/views/login/data.ts` - 登录页面数据

### GitHub Actions
- `.github/workflows/release.yml` - 构建和发布工作流

### 项目文档
- `开发协作规范.md` - 详细的开发规范（364行）
- `会话上下文摘要.md` - 本文件

---

## 🔍 代码片段参考

### 登录表单完整实现
```vue
<script setup lang="ts">
import { ref, onMounted, nextTick } from 'vue'
import { NForm, NFormItem, NInput, NButton } from 'naive-ui'
import { VERSION } from '@/config/version'

const formRef = ref<any>(null)
const formReady = ref(false)
const formModel = ref({
  username: 'admin',
  password: 'admin123'
})

const formRules = {
  username: [{ required: true, message: '请输入用户名', trigger: 'blur' }],
  password: [
    { required: true, message: '请输入密码', trigger: 'blur' },
    { min: 6, max: 15, message: '密码长度在 6 到 15 个字符', trigger: 'blur' }
  ]
}

onMounted(() => {
  nextTick(() => {
    formReady.value = true
  })
})

const handleDirectLogin = (): void => {
  if (!formReady.value || !formRef.value) {
    message.warning('表单正在初始化，请稍候...')
    return
  }
  
  if (!captchaValid.value) {
    message.error('请先完成人机验证')
    return
  }

  formRef.value.validate((errors: any) => {
    if (errors) {
      message.error('表单校验失败,请检查输入')
      return
    }
    
    const { username, password } = formModel.value
    const formScope = {
      model: {
        username,
        password,
        captcha: {
          token: captchaData.value!.token,
          timestamp: captchaData.value!.timestamp,
          type: 'puzzle-captcha',
        },
      }
    }
    
    login(formScope)
  })
}
</script>
```

### 版本号同步脚本
```javascript
// web/scripts/sync-version.js
const fs = require('fs')
const path = require('path')

const packageJson = require('../package.json')
const version = packageJson.version

const versionConfig = `/**
 * 版本号配置
 * 此文件由构建脚本自动生成，请勿手动修改
 */
export const VERSION = '${version}'
`

const targetPath = path.join(__dirname, '../src/config/version.ts')
fs.writeFileSync(targetPath, versionConfig, 'utf-8')

console.log(`✅ 版本号已同步: ${version}`)
```

---

## 📝 提交规范

### 格式
```
<类型>: <简短描述>

[可选的详细描述]
```

### 类型说明
- `feat` / `✨` - 新功能
- `fix` / `🐛` - Bug 修复
- `docs` / `📝` - 文档更新
- `refactor` / `♻️` - 代码重构
- `chore` / `🔧` - 构建/工具变更
- `style` / `💄` - 代码格式调整
- `test` / `✅` - 测试相关

### 示例
```bash
git commit -m "fix: 修复登录表单显示问题"
git commit -m "feat: 添加版本号自动同步机制"
git commit -m "docs: 更新开发协作规范文档"
```

---

## 🤖 AI 助手协作要点

### 每次修改代码后必须检查：
1. ✅ 版本号是否已更新（`web/package.json`）
2. ✅ 代码是否已提交到 Git
3. ✅ 标签是否已创建
4. ✅ 代码是否已推送到 main 分支
5. ✅ 标签是否已单独推送到远程
6. ✅ GitHub Actions 是否正在运行
7. ✅ 构建是否成功
8. ✅ Release 是否已创建（如果推送了标签）

### 标准操作流程示例：
```bash
# 假设修复了一个 bug
cd web
npm version patch  # 1.1.9.11 -> 1.1.9.12

cd ..
git add .
git commit -m "fix: 修复某个问题"

git tag v1.1.9.12
git push origin main      # 先推送代码
git push origin v1.1.9.12 # 再推送标签

# 等待 5-10 分钟，GitHub Actions 会自动构建并发布
```

---

## 📊 版本历史记录

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| v1.1.9.11 | 2025-01-01 | 创建开发协作规范文档 |
| v1.1.9.10 | 2025-01-01 | 修复表单实例未准备好错误 |
| v1.1.9.9 | 2025-01-01 | 修复登录表单显示和构建问题 |

---

## 🔗 相关资源

- **GitHub 仓库**: https://github.com/ShourGG/tailamianban
- **详细开发规范**: 参见项目根目录 `开发协作规范.md`
- **Naive UI 文档**: https://www.naiveui.com/
- **Vue 3 文档**: https://cn.vuejs.org/
- **Vite 文档**: https://cn.vitejs.dev/

---

## 💡 常见问题 FAQ

### Q: 为什么推送标签后没有创建 Release？
A: 确保标签已正确推送到远程。使用 `git push origin v1.x.x.x` 单独推送标签。

### Q: 如何查看 GitHub Actions 构建状态？
A: 访问仓库页面，点击 "Actions" 标签页，查看最新的工作流运行状态。

### Q: 版本号应该如何递增？
A: 
- 补丁号（最后一位）：小修复、文档更新
- 修订号（第三位）：较大的修复、小功能
- 次版本号（第二位）：新功能、重构
- 主版本号（第一位）：重大架构变更、不兼容更新

---

**最后更新**: 2025-01-01  
**文档版本**: v1.0.0