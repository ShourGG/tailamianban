name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

# æˆäºˆ GitHub Actions å¿…è¦çš„æƒé™
permissions:
  contents: write
  packages: write

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Build frontend
      run: |
        cd web
        npm ci --legacy-peer-deps
        npm run build
        cd ..
        
    - name: Upload frontend artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: web/dist

  build-backend:
    needs: build-frontend
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download frontend artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist
        path: cmd/dist

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Install dependencies
      run: |
        go mod download

    - name: Build binary
      env:
        CGO_ENABLED: 1
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        # å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·
        if [ "${{ matrix.goarch }}" = "arm64" ]; then
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          export CC=aarch64-linux-gnu-gcc
        fi
        
        # è·å–ç‰ˆæœ¬å·
        VERSION="${{ github.event.inputs.version || github.ref_name }}"
        
        # ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆåµŒå…¥å‰ç«¯èµ„æºå¹¶æ³¨å…¥ç‰ˆæœ¬å·ï¼‰
        go build -ldflags "-s -w \
          -X main.Version=${VERSION} \
          -X main.Build=release \
          -X terraria-panel/internal/api/handlers.AppVersion=${VERSION} \
          -X terraria-panel/internal/api/handlers.BuildInfo=release" \
          -o terraria-panel cmd/main.go
        
        # ç¡®ä¿äºŒè¿›åˆ¶æ–‡ä»¶å¯æ‰§è¡Œ
        chmod +x terraria-panel

    - name: Package release
      run: |
        # åˆ›å»ºå‘å¸ƒåŒ…ç»“æ„
        mkdir -p release/terraria-panel
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
        cp terraria-panel release/terraria-panel/
        cp -r scripts release/terraria-panel/
        cp -r configs release/terraria-panel/ || true
        cp README.md release/terraria-panel/
        
        # å¦‚æœdistç›®å½•å­˜åœ¨ä¸”äºŒè¿›åˆ¶æ–‡ä»¶æ²¡æœ‰åµŒå…¥ï¼Œåˆ™å¤åˆ¶
        if [ -d "dist" ] && [ ! -f "internal/embedded/embed.go" ]; then
          cp -r dist release/terraria-panel/
        fi
        
        # åˆ›å»ºå¿…è¦çš„ç©ºç›®å½•
        mkdir -p release/terraria-panel/data
        mkdir -p release/terraria-panel/logs
        mkdir -p release/terraria-panel/worlds
        
        # æ‰“åŒ…
        cd release
        tar -czf terraria-panel-${{ matrix.suffix }}.tar.gz terraria-panel
        cd ..

    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: terraria-panel-${{ matrix.suffix }}
        path: release/terraria-panel-${{ matrix.suffix }}.tar.gz

  create-release:
    needs: build-backend
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ github.event.inputs.version || github.ref_name }}"
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^${VERSION}$" | head -n 1)
        
        if [ -z "$PREVIOUS_TAG" ]; then
          CHANGES=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          CHANGES=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
        fi
        
        FEATURES=$(echo "$CHANGES" | grep -E "^- (feat|feature|âœ¨)" || echo "")
        FIXES=$(echo "$CHANGES" | grep -E "^- (fix|ğŸ›)" || echo "")
        DOCS=$(echo "$CHANGES" | grep -E "^- (docs|ğŸ“)" || echo "")
        REFACTOR=$(echo "$CHANGES" | grep -E "^- (refactor|â™»ï¸)" || echo "")
        CHORE=$(echo "$CHANGES" | grep -E "^- (chore|build|ci|ğŸ”§)" || echo "")
        OTHERS=$(echo "$CHANGES" | grep -vE "^- (feat|feature|fix|docs|refactor|chore|build|ci|âœ¨|ğŸ›|ğŸ“|â™»ï¸|ğŸ”§)" || echo "")
        
        CHANGELOG=""
        [ -n "$FEATURES" ] && CHANGELOG="${CHANGELOG}#### âœ¨ æ–°å¢ç‰¹æ€§\n${FEATURES}\n\n"
        [ -n "$FIXES" ] && CHANGELOG="${CHANGELOG}#### ğŸ› Bug ä¿®å¤\n${FIXES}\n\n"
        [ -n "$REFACTOR" ] && CHANGELOG="${CHANGELOG}#### â™»ï¸ ä»£ç é‡æ„\n${REFACTOR}\n\n"
        [ -n "$DOCS" ] && CHANGELOG="${CHANGELOG}#### ğŸ“ æ–‡æ¡£æ›´æ–°\n${DOCS}\n\n"
        [ -n "$CHORE" ] && CHANGELOG="${CHANGELOG}#### ğŸ”§ æ„å»º/å·¥å…·\n${CHORE}\n\n"
        [ -n "$OTHERS" ] && CHANGELOG="${CHANGELOG}#### ğŸ”„ å…¶ä»–å˜æ›´\n${OTHERS}\n\n"
        [ -z "$CHANGELOG" ] && CHANGELOG="#### ğŸ”„ æœ¬æ¬¡æ›´æ–°\n- ç‰ˆæœ¬å‘å¸ƒ\n\n"
        
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        name: Release ${{ github.event.inputs.version || github.ref_name }}
        draft: false
        prerelease: false
        files: |
          terraria-panel-linux-amd64/terraria-panel-linux-amd64.tar.gz
          terraria-panel-linux-arm64/terraria-panel-linux-arm64.tar.gz
        body: |
          ## ğŸ® æ³°æ‹‰ç‘äºšé¢æ¿ ${{ github.event.inputs.version || github.ref_name }}
          
          ### ğŸ“¦ å¿«é€Ÿå®‰è£…
          
          **ä¸€é”®å®‰è£…ï¼ˆæ¨èï¼‰ï¼š**
          ```bash
          curl -fsSL https://raw.githubusercontent.com/ShourGG/tailamianban/main/scripts/install.sh | sudo bash
          ```
          
          **æ‰‹åŠ¨å®‰è£…ï¼š**
          ```bash
          # ä¸‹è½½å¯¹åº”æ¶æ„çš„ç‰ˆæœ¬
          wget https://github.com/ShourGG/tailamianban/releases/download/${{ github.event.inputs.version || github.ref_name }}/terraria-panel-linux-amd64.tar.gz
          
          # è§£å‹å¹¶å¯åŠ¨
          tar -xzf terraria-panel-linux-amd64.tar.gz
          cd terraria-panel && ./scripts/run.sh start
          ```
          
          ---
          
          ### ğŸ”„ æœ¬æ¬¡æ›´æ–°
          
          ${{ steps.release_notes.outputs.CHANGELOG }}
          
          ---
          
          ### ğŸ“ é»˜è®¤é…ç½®
          - **è®¿é—®åœ°å€**: http://your-server-ip:8080
          - **é»˜è®¤ç”¨æˆ·å**: `admin`
          - **é»˜è®¤å¯†ç **: `admin123`
          - **æ•°æ®ç›®å½•**: `./data`
          - **æ—¥å¿—ç›®å½•**: `./logs`
          
          ### âš ï¸ é‡è¦æç¤º
          - é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç 
          - å»ºè®®ä½¿ç”¨ Nginx åå‘ä»£ç†å¹¶é…ç½® HTTPS
          - å®šæœŸå¤‡ä»½ `./data` ç›®å½•