<!--
 * @Author: ChenYu ycyplus@gmail.com
 * @Date: 2025-06-04 19:20:15
 * @LastEditors: ChenYu ycyplus@gmail.com
 * @LastEditTime: 2025-06-10 17:24:15
 * @FilePath: \Robot_Admin\src\views\demo\08-form-modal\index.vue
 * @Description: Â§öÊ®°ÊÄÅË°®Âçï -  ÊºîÁ§∫È°µÈù¢
 * Copyright (c) 2025 by CHENY, All Rights Reserved üòé. 
-->

<template>
  <div class="demo-container">
    <!-- Â§¥ÈÉ® -->
    <div class="header">
      <NH1 class="main-title">Ë°®ÂçïÈÄâÊã©Âô®ÁªÑ‰ª∂Âú∫ÊôØÁ§∫‰æã</NH1>
      <div class="panel-title">
        ÂºπÂá∫ÊéßÂà∂‰∏≠ÂøÉ<span class="subtitle"> / 5Áßç‰∏ªË¶ÅÁöÑË°®ÂçïÂÆπÂô®Âú∫ÊôØ</span>
      </div>
      <div class="stats-overview">
        <NSpace size="large">
          <NStatistic
            v-for="stat in headerStats"
            :key="stat.label"
            :label="stat.label"
            :value="stat.value"
          >
            <template #prefix>
              <Icon :icon="stat.icon" />
            </template>
          </NStatistic>
        </NSpace>
      </div>
    </div>

    <!-- ÂÆπÂô®Âç°ÁâáÁΩëÊ†º -->
    <div class="cards-grid">
      <div
        v-for="card in containerCards"
        :key="card.key"
        class="card-wrapper"
      >
        <NCard
          class="container-card custom-card"
          @click="handleCardAction(card.key)"
        >
          <template #header>
            <div class="card-header">
              <div class="icon-wrapper">
                <Icon
                  :icon="card.icon"
                  class="card-icon"
                  :style="{ color: card.iconColor }"
                />
              </div>
              <div class="header-content">
                <h3 class="card-title">{{ card.title }}</h3>
                <NTag
                  :type="card.tagType"
                  size="small"
                  >{{ card.layout }}</NTag
                >
              </div>
            </div>
          </template>

          <div class="card-body">
            <p class="card-description">{{ card.description }}</p>

            <div class="card-features">
              <NSpace
                wrap
                size="small"
              >
                <NTag
                  v-for="feature in card.features"
                  :key="feature"
                  size="small"
                  round
                >
                  {{ feature }}
                </NTag>
              </NSpace>
            </div>

            <div class="card-stats">
              <div class="stat-item">
                <span class="stat-label">Â≠óÊÆµÊï∞Èáè</span>
                <NBadge
                  :value="card.fields"
                  :type="getBadgeType(card.fields)"
                />
              </div>
              <div class="stat-item">
                <span class="stat-label">Â§çÊùÇÂ∫¶</span>
                <NRate
                  :value="card.complexity"
                  readonly
                  size="small"
                />
              </div>
              <div class="stat-item">
                <span class="stat-label">Áä∂ÊÄÅ</span>
                <NTag
                  :type="getStatusType(card.key)"
                  size="small"
                >
                  {{ getStatusText(card.key) }}
                </NTag>
              </div>
            </div>
          </div>

          <template #action>
            <NButton
              type="primary"
              block
              size="large"
              strong
            >
              <template #icon>
                <i :class="card.actionIcon"></i>
              </template>
              {{ getActionText(card) }}
            </NButton>
          </template>

          <!-- ÊµÆÂä®Ë°®ÂçïÊåâÈíÆ -->
          <div
            v-if="card.key === 'popover'"
            class="card-float-btn"
            @click.stop
          >
            <NPopover
              v-model:show="containerState.popover"
              trigger="click"
              placement="bottom"
            >
              <template #trigger>
                <NButton
                  circle
                  size="small"
                  type="primary"
                  @click.stop="toggleContainer('popover')"
                >
                  <template #icon>
                    <i class="i-mdi:file-settings-cog"></i>
                  </template>
                </NButton>
              </template>
              <div class="popover-content">
                <div class="popover-header">
                  <h4>Âø´ÈÄüÁºñËæë</h4>
                  <NTag
                    size="small"
                    type="info"
                    >ÂÆûÊó∂‰øùÂ≠ò</NTag
                  >
                </div>
                <C_Form
                  ref="popoverFormRef"
                  :options="formOptions.popover"
                  :layout-type="layoutTypes.popover"
                  v-model="formData.popover"
                  @submit="submitForm('popover')"
                >
                  <template #action="{ validate }">
                    <NSpace
                      justify="end"
                      class="mt-4"
                    >
                      <NButton
                        size="small"
                        @click="toggleContainer('popover', false)"
                        >ÂèñÊ∂à</NButton
                      >
                      <NButton
                        size="small"
                        type="primary"
                        @click="validateAndSubmit('popover', validate)"
                      >
                        ‰øùÂ≠ò
                      </NButton>
                    </NSpace>
                  </template>
                </C_Form>
              </div>
            </NPopover>
          </div>
        </NCard>
      </div>
    </div>

    <!-- Ê®°ÊÄÅÊ°Ü -->
    <NModal
      v-model:show="containerState.modal"
      preset="card"
      title="Áî®Êà∑‰ø°ÊÅØÁÆ°ÁêÜ"
      :style="{ width: '600px' }"
      size="large"
    >
      <template #header-extra>
        <NTag
          type="info"
          size="small"
          >ÁΩëÊ†ºÂ∏ÉÂ±Ä</NTag
        >
      </template>
      <C_Form
        ref="modalFormRef"
        :options="formOptions.modal"
        :layout-type="layoutTypes.modal"
        v-model="formData.modal"
        @submit="submitForm('modal')"
      />
    </NModal>

    <!-- ÊäΩÂ±â -->
    <NDrawer
      v-model:show="containerState.drawer"
      :width="500"
      placement="right"
    >
      <NDrawerContent title="ÂïÜÂìÅËØ¶ÊÉÖÈÖçÁΩÆ">
        <template #header-extra>
          <NTag
            type="success"
            size="small"
            >ÈªòËÆ§Â∏ÉÂ±Ä</NTag
          >
        </template>
        <C_Form
          ref="drawerFormRef"
          :options="formOptions.drawer"
          :layout-type="layoutTypes.drawer"
          v-model="formData.drawer"
          @submit="submitForm('drawer')"
          :showDefaultActions="false"
        />
        <template #footer>
          <NSpace justify="end">
            <NButton @click="toggleContainer('drawer', false)">ÂèñÊ∂à</NButton>
            <NButton
              type="primary"
              @click="submitForm('drawer')"
              >‰øùÂ≠ò</NButton
            >
          </NSpace>
        </template>
      </NDrawerContent>
    </NDrawer>

    <!-- ‰æßËæπÊ†è -->
    <div
      class="sidebar"
      :class="{ collapsed: containerState.sidebar }"
    >
      <NCard
        v-if="!containerState.sidebar"
        class="sidebar-card"
      >
        <template #header>
          <div class="sidebar-header">
            <div class="header-info">
              <i class="i-mdi:air-filter mr-2"></i>
              <span>Á≠õÈÄâÊù°‰ª∂</span>
              <NTag
                type="warning"
                size="small"
                class="ml-2"
                >Á¥ßÂáëÂ∏ÉÂ±Ä</NTag
              >
            </div>
            <NButton
              quaternary
              circle
              size="small"
              @click="toggleContainer('sidebar')"
            >
              <template #icon>
                <i class="i-mdi:close-octagon"></i>
              </template>
            </NButton>
          </div>
        </template>
        <C_Form
          ref="sidebarFormRef"
          :options="formOptions.sidebar"
          :layout-type="layoutTypes.sidebar"
          v-model="formData.sidebar"
          @submit="submitForm('sidebar')"
        >
          <template #action="{ validate }">
            <NSpace
              justify="space-between"
              class="mt-4"
            >
              <NButton @click="clearFormData('sidebar')">
                <template #icon>
                  <i class="i-mdi:vacuum-cleaner"></i>
                </template>
                Ê∏ÖÁ©∫
              </NButton>
              <NButton
                type="primary"
                @click="validateAndSubmit('sidebar', validate)"
              >
                <template #icon>
                  <i class="i-mdi:briefcase-search-outline"></i>
                </template>
                Â∫îÁî®Á≠õÈÄâ
              </NButton>
            </NSpace>
          </template>
        </C_Form>
      </NCard>
    </div>

    <!-- Ê≠•È™§ÂêëÂØº -->
    <NModal
      v-model:show="containerState.wizard"
      preset="card"
      title="È°πÁõÆÂàõÂª∫ÂêëÂØº"
      :style="{ width: '900px' }"
      size="huge"
      :closable="false"
    >
      <template #header-extra>
        <NTag
          type="success"
          size="small"
          >Ê≠•È™§Â∏ÉÂ±Ä</NTag
        >
      </template>
      <C_Form
        ref="wizardFormRef"
        :options="formOptions.wizard"
        :layout-type="layoutTypes.wizard"
        v-model="formData.wizard"
        @submit="submitForm('wizard')"
      />
      <template #action>
        <NSpace justify="space-between">
          <NButton @click="toggleContainer('wizard', false)">ÂèñÊ∂à</NButton>
          <NSpace>
            <NButton @click="clearFormData('wizard')">ÈáçÁΩÆ</NButton>
            <NButton
              type="primary"
              @click="submitForm('wizard')"
              >ÂÆåÊàêÂàõÂª∫</NButton
            >
          </NSpace>
        </NSpace>
      </template>
    </NModal>
  </div>
</template>

<script setup lang="ts">
  import type { Ref } from 'vue'
  import type { FormInstance } from '@/types/modules/form'
  import {
    type ContainerType,
    type ContainerCard,
    layoutTypes,
    formOptions,
    containerCards,
    containerConfig,
    createDefaultFormData,
    headerStats,
  } from './data'

  /**
   *
   * @description: Ê∂àÊÅØÊèêÁ§∫ÂÆû‰æã
   * ? @type {MessageApi} Áî®‰∫éÊòæÁ§∫Êìç‰ΩúÊàêÂäü„ÄÅÂ§±Ë¥•Á≠âÊèêÁ§∫‰ø°ÊÅØ
   */
  const message = useMessage()

  /**
   *
   * @description: Áªü‰∏ÄÂÆπÂô®Áä∂ÊÄÅÁÆ°ÁêÜ
   * ? @type {Record<ContainerType, boolean>} ÁÆ°ÁêÜÊâÄÊúâÂÆπÂô®ÁöÑÊòæÁ§∫/ÈöêËóèÁä∂ÊÄÅ
   * * modal: Ê®°ÊÄÅÊ°ÜÊòæÁ§∫Áä∂ÊÄÅ
   * * drawer: ÊäΩÂ±âÊòæÁ§∫Áä∂ÊÄÅ
   * * sidebar: ‰æßËæπÊ†èÊäòÂè†Áä∂ÊÄÅÔºàtrue‰∏∫ÊäòÂè†Ôºâ
   * * popover: Ê∞îÊ≥°Âç°ÁâáÊòæÁ§∫Áä∂ÊÄÅ
   * * wizard: ÂêëÂØºÂºπÁ™óÊòæÁ§∫Áä∂ÊÄÅ
   */
  const containerState = reactive({
    modal: false,
    drawer: false,
    sidebar: true, // collapsedÁä∂ÊÄÅ
    popover: false,
    wizard: false,
  })

  /**
   *
   * @description: Ê®°ÊÄÅÊ°ÜË°®ÂçïÂºïÁî®
   * ? @type {Ref<FormInstance | undefined>} Áî®‰∫éËÆøÈóÆÊ®°ÊÄÅÊ°ÜÂÜÖÁöÑË°®ÂçïÂÆû‰æã
   */
  const modalFormRef = ref<FormInstance>()

  /**
   *
   * @description: ÊäΩÂ±âË°®ÂçïÂºïÁî®
   * ? @type {Ref<FormInstance | undefined>} Áî®‰∫éËÆøÈóÆÊäΩÂ±âÂÜÖÁöÑË°®ÂçïÂÆû‰æã
   */
  const drawerFormRef = ref<FormInstance>()

  /**
   *
   * @description: ‰æßËæπÊ†èË°®ÂçïÂºïÁî®
   * ? @type {Ref<FormInstance | undefined>} Áî®‰∫éËÆøÈóÆ‰æßËæπÊ†èÂÜÖÁöÑË°®ÂçïÂÆû‰æã
   */
  const sidebarFormRef = ref<FormInstance>()

  /**
   *
   * @description: Ê∞îÊ≥°Âç°ÁâáË°®ÂçïÂºïÁî®
   * ? @type {Ref<FormInstance | undefined>} Áî®‰∫éËÆøÈóÆÊ∞îÊ≥°Âç°ÁâáÂÜÖÁöÑË°®ÂçïÂÆû‰æã
   */
  const popoverFormRef = ref<FormInstance>()

  /**
   *
   * @description: ÂêëÂØºË°®ÂçïÂºïÁî®
   * ? @type {Ref<FormInstance | undefined>} Áî®‰∫éËÆøÈóÆÂêëÂØºÂºπÁ™óÂÜÖÁöÑË°®ÂçïÂÆû‰æã
   */
  const wizardFormRef = ref<FormInstance>()

  /**
   *
   * @description: ÂêÑÂÆπÂô®Ë°®ÂçïÊï∞ÊçÆÈõÜÂêà
   * ? @type {Record<ContainerType, any>} Â≠òÂÇ®ÊâÄÊúâÂÆπÂô®ÁöÑË°®ÂçïÊï∞ÊçÆ
   * * ‰ΩøÁî®reactiveÂåÖË£Ö‰ª•ÂÆûÁé∞ÂìçÂ∫îÂºèÊï∞ÊçÆÁªëÂÆö
   */
  const formData = reactive(createDefaultFormData())

  /**
   *
   * @description: Ê†πÊçÆÂ≠óÊÆµÊï∞ÈáèËé∑ÂèñÂæΩÁ´†Á±ªÂûã
   * ? @param {number} fields Ë°®ÂçïÂ≠óÊÆµÊï∞Èáè
   * ! @return {'default' | 'success' | 'warning'} ÂæΩÁ´†Á±ªÂûã
   * * 0-2‰∏™Â≠óÊÆµÔºödefaultÔºàÈªòËÆ§Ôºâ
   * * 3-4‰∏™Â≠óÊÆµÔºösuccessÔºàÊàêÂäüÔºâ
   * * 5‰∏™Âèä‰ª•‰∏äÔºöwarningÔºàË≠¶ÂëäÔºâ
   */
  const getBadgeType = (fields: number): 'default' | 'success' | 'warning' => {
    if (fields <= 2) return 'default'
    if (fields <= 4) return 'success'
    return 'warning'
  }

  /**
   *
   * @description: Ëé∑ÂèñÂÆπÂô®Áä∂ÊÄÅÁ±ªÂûã
   * ? @param {ContainerType} key ÂÆπÂô®Á±ªÂûãÊ†áËØÜ
   * ! @return {string} Áä∂ÊÄÅÁ±ªÂûãÂ≠óÁ¨¶‰∏≤
   * * ‰ªéÈÖçÁΩÆÊñá‰ª∂‰∏≠Ëé∑ÂèñÂØπÂ∫îÂÆπÂô®ÁöÑÁä∂ÊÄÅÁ±ªÂûã
   */
  const getStatusType = (key: ContainerType) => containerConfig[key].statusType

  /**
   *
   * @description: Ëé∑ÂèñÂÆπÂô®Áä∂ÊÄÅÊñáÊú¨
   * ? @param {ContainerType} key ÂÆπÂô®Á±ªÂûãÊ†áËØÜ
   * ! @return {string} Áä∂ÊÄÅÊèèËø∞ÊñáÊú¨
   * * Ê†πÊçÆÂΩìÂâçÂÆπÂô®Áä∂ÊÄÅËøîÂõûÂØπÂ∫îÁöÑÁä∂ÊÄÅÊèèËø∞
   * * ‰æßËæπÊ†èÁâπÊÆäÂ§ÑÁêÜÔºö‰ΩøÁî®collapsedÁä∂ÊÄÅ
   */
  const getStatusText = (key: ContainerType): string => {
    const config = containerConfig[key]
    const state =
      key === 'sidebar' ? containerState.sidebar : containerState[key]
    return config.getStatusText(state)
  }

  /**
   *
   * @description: Ëé∑ÂèñÊìç‰ΩúÊåâÈíÆÊñáÊú¨
   * ? @param {ContainerCard} card ÂÆπÂô®Âç°ÁâáÈÖçÁΩÆÂØπË±°
   * ! @return {string} ÊåâÈíÆÊòæÁ§∫ÊñáÊú¨
   * * ‰æßËæπÊ†èÁâπÊÆäÂ§ÑÁêÜÔºöÊ†πÊçÆÊäòÂè†Áä∂ÊÄÅÊòæÁ§∫"Â±ïÂºÄ"Êàñ"Êî∂Ëµ∑"
   * * ÂÖ∂‰ªñÂÆπÂô®ÔºöÁõ¥Êé•ËøîÂõûÈÖçÁΩÆÁöÑÊìç‰ΩúÊñáÊú¨
   */
  const getActionText = (card: ContainerCard): string => {
    if (card.key === 'sidebar') {
      return containerState.sidebar ? 'Â±ïÂºÄ‰æßËæπÊ†è' : 'Êî∂Ëµ∑‰æßËæπÊ†è'
    }
    return card.actionText
  }

  /**
   *
   * @description: Â§ÑÁêÜÂç°ÁâáÁÇπÂáª‰∫ã‰ª∂
   * ? @param {ContainerType} key ÂÆπÂô®Á±ªÂûãÊ†áËØÜ
   * ! @return {void}
   * * ‰æßËæπÊ†èÔºöÂàáÊç¢ÊäòÂè†/Â±ïÂºÄÁä∂ÊÄÅ
   * * ÂÖ∂‰ªñÂÆπÂô®ÔºöÊâìÂºÄÂØπÂ∫îÁöÑÂÆπÂô®
   */
  const handleCardAction = (key: ContainerType): void => {
    if (key === 'sidebar') {
      toggleContainer('sidebar') // ‰æßËæπÊ†èÈúÄË¶ÅÂàáÊç¢Áä∂ÊÄÅ
    } else {
      toggleContainer(key, true) // ÂÖ∂‰ªñÂÆπÂô®ÊâìÂºÄ
    }
  }

  /**
   *
   * @description: Áªü‰∏ÄÂÆπÂô®ÊòæÁ§∫Áä∂ÊÄÅÊéßÂà∂
   * ? @param {ContainerType} type ÂÆπÂô®Á±ªÂûãÊ†áËØÜ
   * ? @param {boolean} [state] ÂèØÈÄâÁöÑÁõÆÊ†áÁä∂ÊÄÅÔºå‰∏ç‰º†ÂàôÂàáÊç¢ÂΩìÂâçÁä∂ÊÄÅ
   * ! @return {void}
   * * ‰æßËæπÊ†èÔºöÊéßÂà∂ÊäòÂè†/Â±ïÂºÄÁä∂ÊÄÅ
   * * ÂÖ∂‰ªñÂÆπÂô®ÔºöÊéßÂà∂ÊòæÁ§∫/ÈöêËóèÁä∂ÊÄÅ
   */
  const toggleContainer = (type: ContainerType, state?: boolean): void => {
    if (type === 'sidebar') {
      containerState.sidebar = state ?? !containerState.sidebar
    } else {
      containerState[type] = state ?? !containerState[type]
    }
  }

  /**
   *
   * @description: Áªü‰∏ÄË°®ÂçïÊèê‰∫§Â§ÑÁêÜ
   * ? @param {ContainerType} type ÂÆπÂô®Á±ªÂûãÊ†áËØÜ
   * ! @return {Promise<void>} ÂºÇÊ≠•Êèê‰∫§ÁªìÊûú
   * * 1. Ëé∑ÂèñÂØπÂ∫îÁöÑË°®ÂçïÂºïÁî®
   * * 2. ÊâßË°åË°®ÂçïÈ™åËØÅ
   * * 3. È™åËØÅÈÄöËøáÂêéÊèê‰∫§Êï∞ÊçÆ
   * * 4. ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫Âπ∂ÂÖ≥Èó≠ÂÆπÂô®Ôºà‰æßËæπÊ†èÈô§Â§ñÔºâ
   * * 5. È™åËØÅÂ§±Ë¥•Êó∂ÊòæÁ§∫ÈîôËØØÊèêÁ§∫
   */
  const submitForm = async (type: ContainerType): Promise<void> => {
    /**
     *
     * @description: Ë°®ÂçïÂºïÁî®Êò†Â∞ÑË°®
     * ? @type {Record<ContainerType, Ref<FormInstance | undefined>>}
     * * Â∞ÜÂÆπÂô®Á±ªÂûãÊò†Â∞ÑÂà∞ÂØπÂ∫îÁöÑË°®ÂçïÂºïÁî®
     */
    const formRefMap: Record<ContainerType, Ref<FormInstance | undefined>> = {
      modal: modalFormRef,
      drawer: drawerFormRef,
      sidebar: sidebarFormRef,
      popover: popoverFormRef,
      wizard: wizardFormRef,
    }

    const formRef = formRefMap[type].value
    if (!formRef) return

    try {
      await formRef.validate()
      console.log(`${type} form submitted:`, formData[type])
      message.success('Ë°®ÂçïÊèê‰∫§ÊàêÂäüÔºÅ')

      // Ëá™Âä®ÂÖ≥Èó≠ÂÆπÂô®ÔºàsidebarÈô§Â§ñÔºâ
      if (type !== 'sidebar') {
        toggleContainer(type, false)
      }
    } catch {
      message.error('Ë°®ÂçïÈ™åËØÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ËæìÂÖ•')
    }
  }

  /**
   *
   * @description: È™åËØÅÂπ∂Êèê‰∫§Ë°®Âçï
   * ? @param {ContainerType} type ÂÆπÂô®Á±ªÂûãÊ†áËØÜ
   * ? @param {() => Promise<void>} validate È™åËØÅÂáΩÊï∞
   * ! @return {Promise<void>} ÂºÇÊ≠•È™åËØÅÊèê‰∫§ÁªìÊûú
   * * ÂÖàÊâßË°å‰º†ÂÖ•ÁöÑÈ™åËØÅÂáΩÊï∞ÔºåÈ™åËØÅÈÄöËøáÂêéË∞ÉÁî®Áªü‰∏ÄÊèê‰∫§ÊñπÊ≥ï
   * * ‰∏ªË¶ÅÁî®‰∫éËá™ÂÆö‰πâË°®ÂçïÊìç‰ΩúÊåâÈíÆÁöÑÈ™åËØÅÊµÅÁ®ã
   */
  const validateAndSubmit = async (
    type: ContainerType,
    validate: () => Promise<void>
  ): Promise<void> => {
    try {
      await validate()
      await submitForm(type)
    } catch {
      message.error('Ë°®ÂçïÈ™åËØÅÂ§±Ë¥•')
    }
  }

  /**
   *
   * @description: Ê∏ÖÁ©∫ÊåáÂÆöÂÆπÂô®ÁöÑË°®ÂçïÊï∞ÊçÆ
   * ? @param {ContainerType} type ÂÆπÂô®Á±ªÂûãÊ†áËØÜ
   * ! @return {void}
   * * Â∞ÜÂØπÂ∫îÂÆπÂô®ÁöÑË°®ÂçïÊï∞ÊçÆÈáçÁΩÆ‰∏∫Á©∫ÂØπË±°
   * * ÊòæÁ§∫Ê∏ÖÁ©∫ÊàêÂäüÁöÑÊèêÁ§∫‰ø°ÊÅØ
   */
  const clearFormData = (type: ContainerType): void => {
    formData[type] = {}
    message.info('Â∑≤Ê∏ÖÁ©∫Ë°®ÂçïÊï∞ÊçÆ')
  }
</script>

<style lang="scss" scoped>
  @use './index.scss';
</style>
