# 泰拉瑞亚面板威胁模型

## 系统概述

### 系统架构
```
Internet → [防火墙] → [Nginx/反向代理] → [泰拉瑞亚面板:8080] → [泰拉瑞亚服务器:127.0.0.1:7777]
                                                ↓
                                        [SQLite数据库]
                                        [文件系统]
```

### 信任边界
1. **外部网络** ↔ **防火墙** (不信任 → 受控)
2. **防火墙** ↔ **面板应用** (受控 → 信任)
3. **面板应用** ↔ **泰拉瑞亚服务器** (信任 → 信任)
4. **面板应用** ↔ **文件系统** (信任 → 信任)

## 资产识别

### 高价值资产
1. **管理员凭据** - 面板管理员用户名和密码
2. **JWT密钥** - 用于签名和验证JWT token
3. **服务器配置** - 泰拉瑞亚服务器配置文件
4. **世界文件** - 游戏世界数据文件
5. **玩家数据** - 玩家信息和统计数据
6. **系统访问权限** - 服务器系统级别访问权限

### 中等价值资产
1. **操作日志** - 系统和用户操作记录
2. **性能指标** - 系统监控数据
3. **备份文件** - 世界和配置备份
4. **临时文件** - 上传和处理过程中的临时文件

### 低价值资产
1. **静态资源** - 前端静态文件
2. **公开配置** - 非敏感的配置信息

## 威胁分析 (STRIDE模型)

### 1. 身份欺骗 (Spoofing)

#### T1.1 管理员身份欺骗
**威胁描述**: 攻击者尝试冒充合法管理员身份
**攻击向量**:
- 暴力破解登录凭据
- 凭据泄露或社会工程学
- Session劫持
- JWT token伪造

**影响**: 完全控制面板和服务器
**风险等级**: 🔴 高

**缓解措施**:
- 强密码策略 (最少12位，包含大小写字母、数字、特殊字符)
- 账户锁定机制 (5次失败后锁定30分钟)
- JWT token短期有效期 (1小时)
- 安全的token存储 (HttpOnly Cookie)
- 双因素认证 (计划功能)

#### T1.2 玩家身份欺骗
**威胁描述**: 恶意用户冒充其他玩家身份
**攻击向量**:
- IP地址欺骗
- 用户名冲突利用
- 网络中间人攻击

**影响**: 破坏游戏体验，数据混乱
**风险等级**: 🟡 中

**缓解措施**:
- 玩家唯一标识符
- IP地址验证和记录
- 连接加密 (计划功能)

### 2. 篡改 (Tampering)

#### T2.1 配置文件篡改
**威胁描述**: 攻击者修改服务器配置文件
**攻击向量**:
- 文件系统直接访问
- 通过面板API恶意修改
- 上传恶意配置文件

**影响**: 服务器行为异常，安全策略失效
**风险等级**: 🔴 高

**缓解措施**:
- 文件权限控制 (只有面板进程可写)
- 配置验证和净化
- 配置变更审计日志
- 配置文件备份和恢复

#### T2.2 世界文件篡改
**威胁描述**: 恶意修改游戏世界文件
**攻击向量**:
- 上传恶意世界文件
- 直接文件系统访问
- 通过面板功能恶意操作

**影响**: 游戏数据损坏，玩家体验破坏
**风险等级**: 🟡 中

**缓解措施**:
- 世界文件格式验证
- 文件大小限制 (最大500MB)
- 自动备份机制
- 文件完整性检查

#### T2.3 日志篡改
**威胁描述**: 攻击者修改或删除审计日志
**攻击向量**:
- 文件系统直接访问
- 日志轮转漏洞利用
- 权限提升攻击

**影响**: 审计追踪失效，事件响应困难
**风险等级**: 🟡 中

**缓解措施**:
- 只追加日志文件
- 日志文件权限保护
- 远程日志备份 (计划功能)
- 日志完整性验证

### 3. 否认 (Repudiation)

#### T3.1 操作否认
**威胁描述**: 用户否认执行了某些操作
**攻击向量**:
- 缺乏充分的审计日志
- 共享账户使用
- 时间戳不准确

**影响**: 责任追踪困难，安全事件调查受阻
**风险等级**: 🟡 中

**缓解措施**:
- 详细的操作审计日志
- 用户会话跟踪
- 准确的时间戳记录
- 数字签名 (计划功能)

### 4. 信息泄露 (Information Disclosure)

#### T4.1 敏感配置泄露
**威胁描述**: 敏感配置信息被未授权访问
**攻击向量**:
- API响应包含敏感信息
- 错误消息泄露内部信息
- 日志文件包含敏感数据
- 备份文件访问

**影响**: 系统内部信息暴露，为进一步攻击提供信息
**风险等级**: 🟡 中

**缓解措施**:
- API响应数据过滤
- 通用错误消息
- 敏感数据脱敏
- 备份文件加密

#### T4.2 玩家隐私泄露
**威胁描述**: 玩家个人信息被泄露
**攻击向量**:
- 数据库直接访问
- API权限控制不当
- 日志记录过度详细

**影响**: 隐私泄露，法律合规风险
**风险等级**: 🟡 中

**缓解措施**:
- 最小化数据收集
- 数据访问权限控制
- 个人信息加密存储
- 数据保留策略

#### T4.3 系统信息泄露
**威胁描述**: 系统架构和版本信息泄露
**攻击向量**:
- HTTP头信息泄露
- 错误页面信息泄露
- 探测攻击

**影响**: 为针对性攻击提供信息
**风险等级**: 🟢 低

**缓解措施**:
- 隐藏服务器版本信息
- 自定义错误页面
- 最小化响应头信息

### 5. 拒绝服务 (Denial of Service)

#### T5.1 资源耗尽攻击
**威胁描述**: 攻击者消耗系统资源导致服务不可用
**攻击向量**:
- 大量并发请求
- 大文件上传攻击
- 内存泄露利用
- CPU密集型操作滥用

**影响**: 服务不可用，用户体验受损
**风险等级**: 🟡 中

**缓解措施**:
- 请求频率限制 (每IP每分钟最多60请求)
- 文件上传大小限制
- 连接数限制
- 资源使用监控和告警

#### T5.2 应用层DoS
**威胁描述**: 针对应用逻辑的拒绝服务攻击
**攻击向量**:
- 复杂查询攻击
- 长时间运行的操作
- 死锁诱发

**影响**: 应用响应缓慢或停止服务
**风险等级**: 🟡 中

**缓解措施**:
- 查询超时设置
- 操作时间限制
- 数据库连接池管理
- 异步处理长时间操作

### 6. 权限提升 (Elevation of Privilege)

#### T6.1 水平权限提升
**威胁描述**: 普通用户获得其他用户权限
**攻击向量**:
- 不安全的直接对象引用
- 会话固定攻击
- 权限检查绕过

**影响**: 未授权访问其他用户数据
**风险等级**: 🟡 中

**缓解措施**:
- 严格的权限检查
- 间接对象引用
- 会话管理安全

#### T6.2 垂直权限提升
**威胁描述**: 普通用户获得管理员权限
**攻击向量**:
- 权限检查漏洞
- API权限控制不当
- 配置错误利用

**影响**: 完全控制系统
**风险等级**: 🔴 高

**缓解措施**:
- 多层权限验证
- 最小权限原则
- 权限矩阵验证
- 定期权限审计

#### T6.3 系统权限提升
**威胁描述**: 应用权限提升到系统级别
**攻击向量**:
- 命令注入攻击
- 路径遍历攻击
- 缓冲区溢出 (Go语言相对安全)

**影响**: 完全控制服务器系统
**风险等级**: 🔴 高

**缓解措施**:
- 输入验证和净化
- 命令参数化
- 最小运行权限
- 容器化部署 (计划功能)

## 攻击场景分析

### 场景1: 外部攻击者尝试获取系统控制权
**攻击路径**:
1. 端口扫描发现8080端口开放
2. 尝试暴力破解管理员密码
3. 成功登录后尝试上传恶意文件
4. 利用文件上传漏洞获取系统权限

**防护措施**:
- 防火墙配置
- 账户锁定机制
- 文件类型和大小验证
- 最小权限运行

### 场景2: 内部用户恶意操作
**攻击路径**:
1. 合法用户登录系统
2. 尝试访问未授权功能
3. 修改关键配置文件
4. 删除重要数据

**防护措施**:
- 细粒度权限控制
- 操作审计日志
- 关键操作二次确认
- 数据备份机制

### 场景3: 供应链攻击
**攻击路径**:
1. 第三方依赖包被恶意修改
2. 构建过程中注入恶意代码
3. 部署包含后门的版本

**防护措施**:
- 依赖包版本锁定
- 构建过程安全
- 代码签名验证
- 安全扫描

## 安全控制措施

### 认证和授权
```yaml
认证机制:
  - 用户名密码认证
  - JWT token验证
  - 会话管理
  - 账户锁定

授权机制:
  - 基于角色的访问控制 (RBAC)
  - 资源级别权限检查
  - API端点权限验证
  - 操作权限矩阵
```

### 数据保护
```yaml
传输加密:
  - HTTPS/TLS 1.3
  - WebSocket Secure (WSS)
  - 证书管理

存储加密:
  - 密码哈希 (bcrypt)
  - 敏感配置加密
  - 数据库加密 (计划)
  - 备份文件加密
```

### 输入验证
```yaml
验证策略:
  - 白名单验证
  - 数据类型检查
  - 长度限制
  - 格式验证
  - SQL注入防护
  - XSS防护
  - 命令注入防护
```

### 监控和日志
```yaml
安全监控:
  - 登录失败监控
  - 异常操作检测
  - 资源使用监控
  - 网络流量分析

日志记录:
  - 认证事件
  - 授权失败
  - 配置变更
  - 文件操作
  - 系统错误
```

## 安全配置基线

### 系统配置
```bash
# 防火墙配置
ufw --force reset
ufw default deny incoming
ufw default allow outgoing
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw --force enable

# 文件权限
chmod 600 /opt/terraria-panel/config/*
chmod 700 /opt/terraria-panel/data/
chmod 755 /opt/terraria-panel/terraria-panel
chown -R terraria:terraria /opt/terraria-panel/
```

### 应用配置
```yaml
安全配置:
  jwt_secret: "随机生成的256位密钥"
  session_timeout: 3600  # 1小时
  max_login_attempts: 5
  lockout_duration: 1800  # 30分钟
  password_min_length: 12
  file_upload_max_size: 524288000  # 500MB
  rate_limit_requests: 60  # 每分钟
  rate_limit_window: 60    # 60秒窗口
```

## 事件响应计划

### 安全事件分类
1. **P1 - 严重**: 系统被完全控制
2. **P2 - 高**: 数据泄露或权限提升
3. **P3 - 中**: 服务中断或异常访问
4. **P4 - 低**: 可疑活动或配置问题

### 响应流程
1. **检测**: 自动监控和手动报告
2. **分析**: 确定事件类型和影响范围
3. **遏制**: 隔离受影响系统
4. **根除**: 清除威胁和修复漏洞
5. **恢复**: 恢复正常服务
6. **总结**: 事后分析和改进

### 联系信息
```yaml
紧急联系:
  系统管理员: admin@example.com
  安全团队: security@example.com
  技术支持: support@example.com

外部资源:
  CERT: https://www.cert.org/
  CVE数据库: https://cve.mitre.org/
  安全公告: https://github.com/ShourGG/tailamianban/security/advisories
```

## 合规性考虑

### 数据保护法规
- **GDPR**: 欧盟通用数据保护条例
- **CCPA**: 加州消费者隐私法案
- **个人信息保护法**: 中国个人信息保护法

### 安全标准
- **OWASP Top 10**: Web应用安全风险
- **NIST框架**: 网络安全框架
- **ISO 27001**: 信息安全管理体系

## 定期安全评估

### 评估计划
- **每月**: 漏洞扫描和补丁管理
- **每季度**: 渗透测试和代码审计
- **每年**: 全面安全评估和威胁模型更新

### 安全指标
- 平均检测时间 (MTTD)
- 平均响应时间 (MTTR)
- 安全事件数量
- 漏洞修复时间
- 用户安全培训完成率