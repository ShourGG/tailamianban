# 🎮 泰拉瑞亚服务器管理面板 - 完整制作教程

## 📋 项目概述

**项目名称**: 泰拉瑞亚服务器管理面板  
**技术栈**: Go + Vue3 + SQLite  
**部署方式**: Linux服务器 + systemd服务  
**功能**: 服务器启停、配置管理、玩家管理、备份恢复

---

## 🏗️ 项目架构

```
terraria-panel/
├── backend/                 # Go后端
│   ├── main.go             # 主程序入口
│   ├── handlers/           # API处理器
│   ├── models/             # 数据模型
│   ├── services/           # 业务逻辑
│   └── go.mod              # Go依赖
├── frontend/               # Vue3前端
│   ├── src/                # 源码
│   ├── dist/               # 构建产物
│   └── package.json        # 前端依赖
├── scripts/                # 部署脚本
└── docs/                   # 文档
```

---

## 🚀 第一步：环境准备

### 1.1 服务器要求
- **操作系统**: Ubuntu 20.04+ / CentOS 7+
- **内存**: 最低2GB，推荐4GB+
- **存储**: 最低20GB可用空间
- **网络**: 公网IP，**只需开放一个端口** (80/443或8080)

### 1.2 端口设计原则 ⭐
```
✅ 正确设计: 单端口统一入口
公网端口: 80/443 (生产) 或 8080 (开发)
├── / (前端页面)
├── /api/ (后端API)
└── /ws/ (WebSocket)

内网服务:
├── 面板后端: 127.0.0.1:8080
└── 泰拉瑞亚: 127.0.0.1:7777 (不对外开放!)

❌ 错误设计: 多端口暴露
前端:3000 + 后端:8080 + 游戏:7777 = 安全风险!
```

### 1.2 基础软件安装
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要工具
sudo apt install -y wget curl git unzip

# 安装Go (1.19+)
wget https://go.dev/dl/go1.21.0.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
source ~/.bashrc

# 验证安装
go version
```

---

## 🔧 第二步：后端开发

### 2.1 初始化Go项目
```bash
mkdir terraria-panel && cd terraria-panel
mkdir backend && cd backend
go mod init terraria-panel
```

### 2.2 核心依赖
```bash
go get github.com/gin-gonic/gin
go get github.com/gin-contrib/cors
go get gorm.io/gorm
go get gorm.io/driver/sqlite
go get github.com/joho/godotenv
```

### 2.3 主程序结构 (main.go)
```go
package main

import (
    "log"
    "net/http"
    "github.com/gin-gonic/gin"
    "github.com/gin-contrib/cors"
)

func main() {
    // 创建Gin引擎
    r := gin.Default()
    
    // 配置CORS
    r.Use(cors.Default())
    
    // 静态文件服务 (关键配置!)
    r.Static("/assets", "./frontend/dist/assets")
    r.Static("/js", "./frontend/dist/js")
    r.StaticFile("/favicon.ico", "./frontend/dist/favicon.ico")
    
    // SPA路由支持 (重要!)
    r.NoRoute(func(c *gin.Context) {
        c.File("./frontend/dist/index.html")
    })
    
    // API路由
    api := r.Group("/api/v1")
    {
        api.GET("/health", healthCheck)
        api.GET("/server/status", getServerStatus)
        api.POST("/server/start", startServer)
        api.POST("/server/stop", stopServer)
    }
    
    log.Println("🚀 泰拉瑞亚面板启动成功!")
    log.Println("🌐 Web界面: http://localhost:8080")
    log.Println("📊 API文档: http://localhost:8080/api/v1/health")
    
    r.Run(":8080")
}

func healthCheck(c *gin.Context) {
    c.JSON(http.StatusOK, gin.H{
        "message": "Terraria Panel API is running",
        "status":  "ok",
        "version": "1.0.0",
        "service": "terraria-panel",
    })
}

func getServerStatus(c *gin.Context) {
    // TODO: 实现服务器状态检查
    c.JSON(http.StatusOK, gin.H{
        "status": "stopped",
        "players": 0,
        "uptime": "0s",
    })
}

func startServer(c *gin.Context) {
    // TODO: 实现服务器启动
    c.JSON(http.StatusOK, gin.H{"message": "Server starting..."})
}

func stopServer(c *gin.Context) {
    // TODO: 实现服务器停止
    c.JSON(http.StatusOK, gin.H{"message": "Server stopping..."})
}
```

---

## 🎨 第三步：前端开发

### 3.1 Vue3项目初始化
```bash
cd ../
npm create vue@latest frontend
cd frontend
npm install
```

### 3.2 核心依赖
```bash
npm install axios
npm install @element-plus/icons-vue
npm install element-plus
```

### 3.3 构建前端
```bash
npm run build
# 构建产物在 dist/ 目录
```

---

## 📦 第四步：项目打包

### 4.1 创建构建脚本
```bash
# 创建 scripts/build.sh
#!/bin/bash
set -e

echo "🏗️ 开始构建泰拉瑞亚面板..."

# 构建前端
echo "📦 构建前端..."
cd frontend
npm install
npm run build
cd ..

# 构建后端
echo "🔧 构建后端..."
cd backend
CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -o ../terraria-panel
cd ..

echo "✅ 构建完成!"
echo "📁 可执行文件: ./terraria-panel"
echo "📁 前端文件: ./frontend/dist/"
```

### 4.2 执行构建
```bash
chmod +x scripts/build.sh
./scripts/build.sh
```

---

## 🚀 第五步：服务器部署

### 5.1 创建部署目录
```bash
sudo mkdir -p /opt/terraria-panel
sudo chown $USER:$USER /opt/terraria-panel
```

### 5.2 上传文件
```bash
# 上传可执行文件
scp terraria-panel user@server:/opt/terraria-panel/

# 上传前端文件
scp -r frontend/dist user@server:/opt/terraria-panel/frontend/

# 设置权限
ssh user@server "chmod +x /opt/terraria-panel/terraria-panel"
```

### 5.3 创建systemd服务
```bash
sudo cat > /etc/systemd/system/terraria-panel.service << 'EOF'
[Unit]
Description=Terraria Panel Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/terraria-panel
ExecStart=/opt/terraria-panel/terraria-panel
Restart=always
RestartSec=5
Environment=GIN_MODE=release

[Install]
WantedBy=multi-user.target
EOF
```

### 5.4 启动服务
```bash
sudo systemctl daemon-reload
sudo systemctl enable terraria-panel
sudo systemctl start terraria-panel
sudo systemctl status terraria-panel
```

---

## 🔍 第六步：问题排查

### 6.1 常见问题

**问题1: 页面空白**
```bash
# 检查静态文件
ls -la /opt/terraria-panel/frontend/dist/

# 检查服务日志
sudo journalctl -u terraria-panel -f

# 解决方案: 确保WorkingDirectory正确
sudo systemctl edit --full terraria-panel
# 添加: WorkingDirectory=/opt/terraria-panel
```

**问题2: API无法访问**
```bash
# 检查端口监听
sudo netstat -tlnp | grep 8080

# 检查防火墙
sudo ufw allow 8080
```

**问题3: 权限问题**
```bash
# 修复文件权限
sudo chown -R root:root /opt/terraria-panel
sudo chmod +x /opt/terraria-panel/terraria-panel
```

### 6.2 调试命令
```bash
# 查看服务状态
sudo systemctl status terraria-panel

# 查看实时日志
sudo journalctl -u terraria-panel -f

# 重启服务
sudo systemctl restart terraria-panel

# 检查配置
sudo systemctl cat terraria-panel
```

---

## 🎯 第七步：一键安装脚本

### 7.1 创建自动安装脚本
```bash
# 创建 install.sh
#!/bin/bash
set -e

echo "🎮 泰拉瑞亚面板一键安装脚本"
echo "================================"

# 检查系统
if [[ "$EUID" -ne 0 ]]; then
    echo "❌ 请使用root权限运行此脚本"
    exit 1
fi

# 安装依赖
echo "📦 安装系统依赖..."
apt update && apt install -y wget curl unzip

# 创建目录
echo "📁 创建安装目录..."
mkdir -p /opt/terraria-panel/{frontend,terraria,logs,backups,data}
cd /opt/terraria-panel

# 下载程序
echo "⬇️ 下载程序文件..."
wget -O terraria-panel https://github.com/你的用户名/terraria-panel/releases/latest/download/terraria-panel
chmod +x terraria-panel

# 下载前端
echo "⬇️ 下载前端文件..."
wget -O frontend.tar.gz https://github.com/你的用户名/terraria-panel/releases/latest/download/frontend.tar.gz
tar -xzf frontend.tar.gz -C frontend/
rm frontend.tar.gz

# 创建配置文件
echo "⚙️ 创建配置文件..."
cat > .env << 'EOF'
# 服务器配置
PORT=8080
GIN_MODE=release

# 数据库配置
DB_PATH=./data/panel.db

# 泰拉瑞亚服务器配置
TERRARIA_PATH=./terraria
TERRARIA_WORLD_PATH=./terraria/worlds
TERRARIA_CONFIG_PATH=./terraria/config

# 管理员配置
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin123

# 日志配置
LOG_LEVEL=info
LOG_PATH=./logs
EOF

# 创建systemd服务
echo "🔧 创建系统服务..."
cat > /etc/systemd/system/terraria-panel.service << 'EOF'
[Unit]
Description=Terraria Panel Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/terraria-panel
ExecStart=/opt/terraria-panel/terraria-panel
Restart=always
RestartSec=5
Environment=GIN_MODE=release

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
echo "🚀 启动服务..."
systemctl daemon-reload
systemctl enable terraria-panel
systemctl start terraria-panel

# 检查状态
sleep 3
if systemctl is-active --quiet terraria-panel; then
    echo "✅ 安装成功!"
    echo ""
    echo "🌐 访问地址: http://$(curl -s ifconfig.me):8080"
    echo "👤 默认账号: admin"
    echo "🔑 默认密码: admin123"
    echo ""
    echo "📊 查看状态: systemctl status terraria-panel"
    echo "📋 查看日志: journalctl -u terraria-panel -f"
else
    echo "❌ 安装失败，请检查日志: journalctl -u terraria-panel"
fi
```

### 7.2 使用方法
```bash
# 下载并运行安装脚本
curl -fsSL https://raw.githubusercontent.com/你的用户名/terraria-panel/main/install.sh | bash

# 或者手动下载
wget https://raw.githubusercontent.com/你的用户名/terraria-panel/main/install.sh
chmod +x install.sh
sudo ./install.sh
```

---

## 🔧 第八步：高级功能

### 8.1 泰拉瑞亚服务器集成
```go
// 添加到后端代码
func startTerrariaServer(c *gin.Context) {
    cmd := exec.Command("./terraria/TerrariaServer.exe", "-config", "./terraria/config.txt")
    cmd.Dir = "/opt/terraria-panel"

    if err := cmd.Start(); err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }

    c.JSON(200, gin.H{"message": "服务器启动成功", "pid": cmd.Process.Pid})
}
```

### 8.2 实时监控
```javascript
// 前端WebSocket连接
const ws = new WebSocket('ws://localhost:8080/ws')
ws.onmessage = (event) => {
    const data = JSON.parse(event.data)
    updateServerStatus(data)
}
```

### 8.3 自动备份
```bash
# 添加定时任务
echo "0 2 * * * /opt/terraria-panel/scripts/backup.sh" | crontab -
```

---

## 🛡️ 第九步：安全加固

### 9.1 防火墙配置
```bash
# 只开放必要端口
ufw --force reset
ufw default deny incoming
ufw default allow outgoing
ufw allow ssh
ufw allow 8080/tcp
ufw --force enable
```

### 9.2 SSL证书 (可选)
```bash
# 使用Let's Encrypt
apt install -y certbot
certbot certonly --standalone -d your-domain.com
```

### 9.3 单端口反向代理 (推荐生产架构) ⭐
```nginx
# /etc/nginx/sites-available/terraria-panel
server {
    listen 80;  # 只开放一个公网端口!
    server_name your-domain.com;

    # 前端静态文件 (优先级最高)
    location / {
        root /opt/terraria-panel/frontend/dist;
        try_files $uri $uri/ /index.html;

        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # 后端API代理
    location /api/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket代理 (实时通信)
    location /ws/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}

# HTTPS版本 (生产必备)
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # 其他配置同上...
}
```

### 9.4 防火墙配置 (单端口策略)
```bash
# 重置防火墙
ufw --force reset

# 默认策略
ufw default deny incoming
ufw default allow outgoing

# 只开放必要端口
ufw allow ssh                    # SSH管理
ufw allow 80/tcp                 # HTTP (生产)
ufw allow 443/tcp                # HTTPS (生产)
# ufw allow 8080/tcp             # 开发环境 (可选)

# 启用防火墙
ufw --force enable

# 检查状态
ufw status numbered
```

### 9.5 内网服务安全
```bash
# 确保泰拉瑞亚只监听内网
# 在泰拉瑞亚配置文件中设置:
# ip=127.0.0.1
# port=7777

# 检查端口监听
netstat -tlnp | grep :7777
# 应该显示: 127.0.0.1:7777 (不是 0.0.0.0:7777)
```

---

## 📚 参考资源

- **Go Gin框架**: https://gin-gonic.com/
- **Vue3官方文档**: https://vuejs.org/
- **泰拉瑞亚服务器**: https://terraria.fandom.com/wiki/Server
- **systemd服务**: https://systemd.io/

---

## 🎉 总结

这个完整教程包含：

1. **开发环境搭建** - Go + Vue3 + 工具链
2. **项目架构设计** - 前后端分离，RESTful API
3. **核心功能实现** - 服务器管理，状态监控
4. **部署自动化** - 一键安装脚本，systemd服务
5. **问题排查指南** - 常见问题和解决方案
6. **安全加固** - 防火墙，SSL，反向代理

**关键成功因素**:
- 正确的静态文件服务配置
- 合适的工作目录设置
- 完善的错误处理和日志
- 自动化的部署流程

**老王的建议**: 先跑通基础功能，再逐步添加高级特性。代码要写得简洁明了，部署要做到一键搞定！

---

*老王暴躁技术流出品 - 专治各种不服 - 2024年9月*
