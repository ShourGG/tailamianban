# ✅ 泰拉瑞亚后端 API - 完成说明

## 🎉 已完成！

我已经为你创建了一个完整的 **Go + Gin** 后端API项目，参考了饥荒管理平台DMP的架构！

---

## 📂 项目结构

```
terraria-api/
├── main.go                      # ✅ 入口文件
├── go.mod                       # ✅ Go依赖管理
├── .gitignore                   # ✅ Git忽略文件
├── README.md                    # ✅ 项目文档
│
├── config/                      # ✅ 配置目录
│   └── config.go                # 全局配置
│
├── app/                         # ✅ 应用层
│   ├── controller/              # 控制器
│   │   └── room_controller.go  # ✅ 房间控制器
│   │
│   ├── service/                 # 服务层
│   │   └── room_service.go     # ✅ 房间服务（业务逻辑）
│   │
│   ├── model/                   # 数据模型
│   │   └── room.go             # ✅ 数据库模型定义
│   │
│   ├── router/                  # 路由
│   │   └── router.go           # ✅ 路由配置
│   │
│   └── middleware/              # 中间件（预留）
│
├── utils/                       # ✅ 工具函数
│   ├── db.go                   # 数据库连接
│   └── response.go             # 统一响应格式
│
└── scheduler/                   # 定时任务（预留）
```

---

## 🎯 已实现的功能

### 1. 房间管理 CRUD
- ✅ 创建房间（支持三种类型）
- ✅ 获取房间列表
- ✅ 获取房间详情
- ✅ 更新房间配置
- ✅ 删除房间

### 2. 服务器控制
- ✅ 启动服务器
- ✅ 停止服务器
- ✅ 重启服务器
- ✅ 获取服务器状态

### 3. 数据库
- ✅ SQLite数据库
- ✅ GORM ORM框架
- ✅ 自动建表
- ✅ 支持三种服务器类型配置

### 4. 基础功能
- ✅ CORS跨域支持
- ✅ 统一响应格式
- ✅ 端口冲突检测
- ✅ 进程管理（PID记录）

---

## 📡 API接口列表

### 房间管理
```
GET    /api/terraria/rooms           - 获取房间列表
GET    /api/terraria/rooms/:id       - 获取房间详情
POST   /api/terraria/rooms           - 创建房间
PUT    /api/terraria/rooms/:id       - 更新房间
DELETE /api/terraria/rooms/:id       - 删除房间
```

### 服务器控制
```
POST   /api/terraria/rooms/:id/start    - 启动服务器
POST   /api/terraria/rooms/:id/stop     - 停止服务器
POST   /api/terraria/rooms/:id/restart  - 重启服务器
GET    /api/terraria/rooms/:id/status   - 获取服务器状态
```

### 健康检查
```
GET    /health                          - 健康检查
```

---

## 🚀 如何运行

### 1. 安装Go

Windows下载：https://golang.org/dl/

验证安装：
```bash
go version
```

### 2. 下载依赖

```bash
cd terraria-api
go mod download
```

如果下载慢，可以设置Go代理：
```bash
# Windows PowerShell
$env:GOPROXY="https://goproxy.cn,direct"
go mod download

# Windows CMD
set GOPROXY=https://goproxy.cn,direct
go mod download
```

### 3. 运行

```bash
# 使用默认配置（端口8080）
go run main.go

# 指定端口
go run main.go -p 8000
```

看到以下输出表示启动成功：
```
╔════════════════════════════════════════════════╗
║                                                ║
║     🎮 泰拉瑞亚服务器管理平台 API 🎮           ║
║                                                ║
╚════════════════════════════════════════════════╝

✅ 数据库连接成功
✅ 数据库表创建成功
✅ 配置初始化成功
🚀 泰拉瑞亚管理平台 API 启动成功！
📡 监听地址: http://localhost:8080
```

### 4. 测试API

```bash
# 健康检查
curl http://localhost:8080/health

# 获取房间列表
curl http://localhost:8080/api/terraria/rooms
```

---

## 🔨 编译可执行文件

### Windows
```bash
go build -o terraria-api.exe
```

### Linux（交叉编译）
```bash
set GOOS=linux
set GOARCH=amd64
go build -o terraria-api-linux
```

编译后得到单个可执行文件，部署超方便！

---

## 🔗 前后端对接

### 前端修改

编辑 `terraria-admin/.env.development`：
```env
VITE_API_BASE_URL=http://localhost:8080/api
```

### API响应格式

所有API统一返回格式：
```json
{
  "code": "0",
  "data": {...},
  "msg": "成功"
}
```

---

## 📊 数据库

### 位置
```
terraria-api/config/terraria.db
```

### 表结构

1. **rooms** - 房间表
   - 房间基础信息
   - 服务器类型、状态
   - 端口、玩家数等

2. **world_configs** - 世界配置表
   - 世界大小、难度
   - 游戏设置

3. **tshock_configs** - TShock配置表
   - REST API配置
   - 管理员密码

4. **tmodloader_configs** - TModLoader配置表
   - Mod列表

5. **players** - 玩家表（预留）

---

## 🎯 技术栈

### 核心框架
- **Go 1.23** - 编程语言
- **Gin 1.10** - Web框架（高性能、路由快）
- **GORM** - ORM框架（数据库操作）

### 参考项目技术栈（DMP）
```go
// 来自 dst-management-platform-api/go.mod
require (
    github.com/gin-gonic/gin v1.10.0          // ✅ Web框架
    github.com/gorilla/websocket v1.5.3       // 🔜 WebSocket
    github.com/go-co-op/gocron v1.37.0        // 🔜 定时任务
    github.com/shirou/gopsutil/v3 v3.24.5     // 🔜 系统监控
    github.com/dgrijalva/jwt-go v3.2.0        // 🔜 JWT认证
)
```

---

## 🚧 待实现功能

### 1. 插件管理（TShock）
```
GET    /api/terraria/rooms/:roomId/plugins
POST   /api/terraria/rooms/:roomId/plugins
PUT    /api/terraria/rooms/:roomId/plugins/:id
DELETE /api/terraria/rooms/:roomId/plugins/:id
```

### 2. Mod管理（TModLoader）
```
GET    /api/terraria/rooms/:roomId/mods
POST   /api/terraria/rooms/:roomId/mods
PUT    /api/terraria/rooms/:roomId/mods/:id
DELETE /api/terraria/rooms/:roomId/mods/:id
```

### 3. 玩家管理
```
GET    /api/terraria/rooms/:roomId/players
POST   /api/terraria/rooms/:roomId/players/:id/kick
POST   /api/terraria/rooms/:roomId/players/:id/ban
PUT    /api/terraria/rooms/:roomId/players/:id/group
```

### 4. 世界管理
```
GET    /api/terraria/rooms/:roomId/worlds
POST   /api/terraria/rooms/:roomId/worlds        (上传)
GET    /api/terraria/rooms/:roomId/worlds/:name  (下载)
DELETE /api/terraria/rooms/:roomId/worlds/:name
```

### 5. 控制台
```
POST   /api/terraria/rooms/:roomId/console/execute
```

### 6. 日志
```
GET    /api/terraria/rooms/:roomId/logs
```

### 7. WebSocket实时通信
```
WS     /ws/rooms/:roomId/logs      - 实时日志
WS     /ws/rooms/:roomId/players   - 实时玩家状态
```

### 8. 用户认证
```
POST   /api/auth/login
POST   /api/auth/register
POST   /api/auth/logout
```

### 9. 定时任务
- 自动备份
- 定时重启
- 崩溃自动恢复

### 10. 系统监控
- CPU使用率
- 内存使用率
- 磁盘空间

---

## 🔧 核心文件说明

### main.go
程序入口，启动HTTP服务器

### app/model/room.go
数据模型定义，包括：
- Room（房间）
- WorldConfig（世界配置）
- TShockConfig（TShock配置）
- TModLoaderConfig（TModLoader配置）
- Player（玩家）

### app/service/room_service.go
业务逻辑层，包括：
- CRUD操作
- 服务器启动/停止
- 进程管理
- **TODO: 需要实现真实的服务器启动命令**

### app/controller/room_controller.go
控制器层，处理HTTP请求

### app/router/router.go
路由配置

---

## 💡 下一步工作

### 立即要做的：
1. **实现真实的服务器启动逻辑**
   - 编辑 `room_service.go` 中的启动函数
   - 配置泰拉瑞亚服务器路径
   - 编写启动命令

2. **前端对接测试**
   - 启动前端（terraria-admin）
   - 启动后端（terraria-api）
   - 测试创建房间、启动服务器

3. **完善服务器控制**
   - 实现Vanilla服务器启动
   - 实现TShock服务器启动
   - 实现TModLoader服务器启动

### 后续扩展：
- 插件管理
- Mod管理
- 玩家管理
- WebSocket实时通信
- 用户认证

---

## 📝 测试API

### 创建TShock房间
```bash
curl -X POST http://localhost:8080/api/terraria/rooms \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试服务器",
    "type": "tshock",
    "port": 7777,
    "maxPlayers": 8,
    "worldName": "TestWorld",
    "worldConfig": {
      "size": "2",
      "difficulty": "1",
      "autoSave": true,
      "pvp": false,
      "motd": "欢迎！"
    },
    "tshockConfig": {
      "restApiPort": 7878,
      "restApiToken": "mytoken",
      "superAdminPassword": "admin123"
    }
  }'
```

### 启动服务器
```bash
curl -X POST http://localhost:8080/api/terraria/rooms/1/start
```

---

## 🎓 学习资源

### Go语言
- [Go官方教程](https://go.dev/tour/)
- [Go By Example](https://gobyexample.com/)

### Gin框架
- [Gin官方文档](https://gin-gonic.com/zh-cn/docs/)

### GORM
- [GORM中文文档](https://gorm.io/zh_CN/docs/)

### 参考项目
- [饥荒管理平台DMP](https://github.com/miracleEverywhere/dst-management-platform-api)

---

## ✅ 检查清单

- [x] 创建项目结构
- [x] 实现房间CRUD
- [x] 实现服务器控制
- [x] 数据库集成
- [x] 统一响应格式
- [x] CORS跨域
- [x] API文档
- [ ] 真实服务器启动
- [ ] 前后端联调
- [ ] 插件管理
- [ ] Mod管理
- [ ] 玩家管理
- [ ] WebSocket
- [ ] 用户认证
- [ ] 定时任务

---

## 📞 常见问题

### Q: Go依赖下载太慢？
```bash
# 设置国内代理
$env:GOPROXY="https://goproxy.cn,direct"
go mod download
```

### Q: 如何查看数据库？
```bash
# 使用SQLite查看工具
# 推荐：DB Browser for SQLite
# 下载：https://sqlitebrowser.org/
```

### Q: 端口被占用？
```bash
# 更换端口
go run main.go -p 8081
```

### Q: 如何调试？
```bash
# VS Code安装Go插件
# 或使用 Delve调试器
go install github.com/go-delve/delve/cmd/dlv@latest
dlv debug
```

---

## 🎉 总结

✅ **后端API项目创建完成！**

- 完整的Go+Gin项目结构
- 房间管理功能
- 服务器控制功能
- 数据库集成
- 参考了成熟的DMP项目架构

**下一步**：实现真实的服务器启动逻辑，然后前后端联调！

---

**祝你开发顺利！🚀**
