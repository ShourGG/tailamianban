# âœ… æ³°æ‹‰ç‘äºšåç«¯ API - å®Œæˆè¯´æ˜

## ğŸ‰ å·²å®Œæˆï¼

æˆ‘å·²ç»ä¸ºä½ åˆ›å»ºäº†ä¸€ä¸ªå®Œæ•´çš„ **Go + Gin** åç«¯APIé¡¹ç›®ï¼Œå‚è€ƒäº†é¥¥è’ç®¡ç†å¹³å°DMPçš„æ¶æ„ï¼

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
terraria-api/
â”œâ”€â”€ main.go                      # âœ… å…¥å£æ–‡ä»¶
â”œâ”€â”€ go.mod                       # âœ… Goä¾èµ–ç®¡ç†
â”œâ”€â”€ .gitignore                   # âœ… Gitå¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ README.md                    # âœ… é¡¹ç›®æ–‡æ¡£
â”‚
â”œâ”€â”€ config/                      # âœ… é…ç½®ç›®å½•
â”‚   â””â”€â”€ config.go                # å…¨å±€é…ç½®
â”‚
â”œâ”€â”€ app/                         # âœ… åº”ç”¨å±‚
â”‚   â”œâ”€â”€ controller/              # æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ room_controller.go  # âœ… æˆ¿é—´æ§åˆ¶å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ service/                 # æœåŠ¡å±‚
â”‚   â”‚   â””â”€â”€ room_service.go     # âœ… æˆ¿é—´æœåŠ¡ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ model/                   # æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ room.go             # âœ… æ•°æ®åº“æ¨¡å‹å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ router/                  # è·¯ç”±
â”‚   â”‚   â””â”€â”€ router.go           # âœ… è·¯ç”±é…ç½®
â”‚   â”‚
â”‚   â””â”€â”€ middleware/              # ä¸­é—´ä»¶ï¼ˆé¢„ç•™ï¼‰
â”‚
â”œâ”€â”€ utils/                       # âœ… å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ db.go                   # æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ response.go             # ç»Ÿä¸€å“åº”æ ¼å¼
â”‚
â””â”€â”€ scheduler/                   # å®šæ—¶ä»»åŠ¡ï¼ˆé¢„ç•™ï¼‰
```

---

## ğŸ¯ å·²å®ç°çš„åŠŸèƒ½

### 1. æˆ¿é—´ç®¡ç† CRUD
- âœ… åˆ›å»ºæˆ¿é—´ï¼ˆæ”¯æŒä¸‰ç§ç±»å‹ï¼‰
- âœ… è·å–æˆ¿é—´åˆ—è¡¨
- âœ… è·å–æˆ¿é—´è¯¦æƒ…
- âœ… æ›´æ–°æˆ¿é—´é…ç½®
- âœ… åˆ é™¤æˆ¿é—´

### 2. æœåŠ¡å™¨æ§åˆ¶
- âœ… å¯åŠ¨æœåŠ¡å™¨
- âœ… åœæ­¢æœåŠ¡å™¨
- âœ… é‡å¯æœåŠ¡å™¨
- âœ… è·å–æœåŠ¡å™¨çŠ¶æ€

### 3. æ•°æ®åº“
- âœ… SQLiteæ•°æ®åº“
- âœ… GORM ORMæ¡†æ¶
- âœ… è‡ªåŠ¨å»ºè¡¨
- âœ… æ”¯æŒä¸‰ç§æœåŠ¡å™¨ç±»å‹é…ç½®

### 4. åŸºç¡€åŠŸèƒ½
- âœ… CORSè·¨åŸŸæ”¯æŒ
- âœ… ç»Ÿä¸€å“åº”æ ¼å¼
- âœ… ç«¯å£å†²çªæ£€æµ‹
- âœ… è¿›ç¨‹ç®¡ç†ï¼ˆPIDè®°å½•ï¼‰

---

## ğŸ“¡ APIæ¥å£åˆ—è¡¨

### æˆ¿é—´ç®¡ç†
```
GET    /api/terraria/rooms           - è·å–æˆ¿é—´åˆ—è¡¨
GET    /api/terraria/rooms/:id       - è·å–æˆ¿é—´è¯¦æƒ…
POST   /api/terraria/rooms           - åˆ›å»ºæˆ¿é—´
PUT    /api/terraria/rooms/:id       - æ›´æ–°æˆ¿é—´
DELETE /api/terraria/rooms/:id       - åˆ é™¤æˆ¿é—´
```

### æœåŠ¡å™¨æ§åˆ¶
```
POST   /api/terraria/rooms/:id/start    - å¯åŠ¨æœåŠ¡å™¨
POST   /api/terraria/rooms/:id/stop     - åœæ­¢æœåŠ¡å™¨
POST   /api/terraria/rooms/:id/restart  - é‡å¯æœåŠ¡å™¨
GET    /api/terraria/rooms/:id/status   - è·å–æœåŠ¡å™¨çŠ¶æ€
```

### å¥åº·æ£€æŸ¥
```
GET    /health                          - å¥åº·æ£€æŸ¥
```

---

## ğŸš€ å¦‚ä½•è¿è¡Œ

### 1. å®‰è£…Go

Windowsä¸‹è½½ï¼šhttps://golang.org/dl/

éªŒè¯å®‰è£…ï¼š
```bash
go version
```

### 2. ä¸‹è½½ä¾èµ–

```bash
cd terraria-api
go mod download
```

å¦‚æœä¸‹è½½æ…¢ï¼Œå¯ä»¥è®¾ç½®Goä»£ç†ï¼š
```bash
# Windows PowerShell
$env:GOPROXY="https://goproxy.cn,direct"
go mod download

# Windows CMD
set GOPROXY=https://goproxy.cn,direct
go mod download
```

### 3. è¿è¡Œ

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆç«¯å£8080ï¼‰
go run main.go

# æŒ‡å®šç«¯å£
go run main.go -p 8000
```

çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºè¡¨ç¤ºå¯åŠ¨æˆåŠŸï¼š
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                â•‘
â•‘     ğŸ® æ³°æ‹‰ç‘äºšæœåŠ¡å™¨ç®¡ç†å¹³å° API ğŸ®           â•‘
â•‘                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
âœ… æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ
âœ… é…ç½®åˆå§‹åŒ–æˆåŠŸ
ğŸš€ æ³°æ‹‰ç‘äºšç®¡ç†å¹³å° API å¯åŠ¨æˆåŠŸï¼
ğŸ“¡ ç›‘å¬åœ°å€: http://localhost:8080
```

### 4. æµ‹è¯•API

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8080/health

# è·å–æˆ¿é—´åˆ—è¡¨
curl http://localhost:8080/api/terraria/rooms
```

---

## ğŸ”¨ ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶

### Windows
```bash
go build -o terraria-api.exe
```

### Linuxï¼ˆäº¤å‰ç¼–è¯‘ï¼‰
```bash
set GOOS=linux
set GOARCH=amd64
go build -o terraria-api-linux
```

ç¼–è¯‘åå¾—åˆ°å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œéƒ¨ç½²è¶…æ–¹ä¾¿ï¼

---

## ğŸ”— å‰åç«¯å¯¹æ¥

### å‰ç«¯ä¿®æ”¹

ç¼–è¾‘ `terraria-admin/.env.development`ï¼š
```env
VITE_API_BASE_URL=http://localhost:8080/api
```

### APIå“åº”æ ¼å¼

æ‰€æœ‰APIç»Ÿä¸€è¿”å›æ ¼å¼ï¼š
```json
{
  "code": "0",
  "data": {...},
  "msg": "æˆåŠŸ"
}
```

---

## ğŸ“Š æ•°æ®åº“

### ä½ç½®
```
terraria-api/config/terraria.db
```

### è¡¨ç»“æ„

1. **rooms** - æˆ¿é—´è¡¨
   - æˆ¿é—´åŸºç¡€ä¿¡æ¯
   - æœåŠ¡å™¨ç±»å‹ã€çŠ¶æ€
   - ç«¯å£ã€ç©å®¶æ•°ç­‰

2. **world_configs** - ä¸–ç•Œé…ç½®è¡¨
   - ä¸–ç•Œå¤§å°ã€éš¾åº¦
   - æ¸¸æˆè®¾ç½®

3. **tshock_configs** - TShocké…ç½®è¡¨
   - REST APIé…ç½®
   - ç®¡ç†å‘˜å¯†ç 

4. **tmodloader_configs** - TModLoaderé…ç½®è¡¨
   - Modåˆ—è¡¨

5. **players** - ç©å®¶è¡¨ï¼ˆé¢„ç•™ï¼‰

---

## ğŸ¯ æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶
- **Go 1.23** - ç¼–ç¨‹è¯­è¨€
- **Gin 1.10** - Webæ¡†æ¶ï¼ˆé«˜æ€§èƒ½ã€è·¯ç”±å¿«ï¼‰
- **GORM** - ORMæ¡†æ¶ï¼ˆæ•°æ®åº“æ“ä½œï¼‰

### å‚è€ƒé¡¹ç›®æŠ€æœ¯æ ˆï¼ˆDMPï¼‰
```go
// æ¥è‡ª dst-management-platform-api/go.mod
require (
    github.com/gin-gonic/gin v1.10.0          // âœ… Webæ¡†æ¶
    github.com/gorilla/websocket v1.5.3       // ğŸ”œ WebSocket
    github.com/go-co-op/gocron v1.37.0        // ğŸ”œ å®šæ—¶ä»»åŠ¡
    github.com/shirou/gopsutil/v3 v3.24.5     // ğŸ”œ ç³»ç»Ÿç›‘æ§
    github.com/dgrijalva/jwt-go v3.2.0        // ğŸ”œ JWTè®¤è¯
)
```

---

## ğŸš§ å¾…å®ç°åŠŸèƒ½

### 1. æ’ä»¶ç®¡ç†ï¼ˆTShockï¼‰
```
GET    /api/terraria/rooms/:roomId/plugins
POST   /api/terraria/rooms/:roomId/plugins
PUT    /api/terraria/rooms/:roomId/plugins/:id
DELETE /api/terraria/rooms/:roomId/plugins/:id
```

### 2. Modç®¡ç†ï¼ˆTModLoaderï¼‰
```
GET    /api/terraria/rooms/:roomId/mods
POST   /api/terraria/rooms/:roomId/mods
PUT    /api/terraria/rooms/:roomId/mods/:id
DELETE /api/terraria/rooms/:roomId/mods/:id
```

### 3. ç©å®¶ç®¡ç†
```
GET    /api/terraria/rooms/:roomId/players
POST   /api/terraria/rooms/:roomId/players/:id/kick
POST   /api/terraria/rooms/:roomId/players/:id/ban
PUT    /api/terraria/rooms/:roomId/players/:id/group
```

### 4. ä¸–ç•Œç®¡ç†
```
GET    /api/terraria/rooms/:roomId/worlds
POST   /api/terraria/rooms/:roomId/worlds        (ä¸Šä¼ )
GET    /api/terraria/rooms/:roomId/worlds/:name  (ä¸‹è½½)
DELETE /api/terraria/rooms/:roomId/worlds/:name
```

### 5. æ§åˆ¶å°
```
POST   /api/terraria/rooms/:roomId/console/execute
```

### 6. æ—¥å¿—
```
GET    /api/terraria/rooms/:roomId/logs
```

### 7. WebSocketå®æ—¶é€šä¿¡
```
WS     /ws/rooms/:roomId/logs      - å®æ—¶æ—¥å¿—
WS     /ws/rooms/:roomId/players   - å®æ—¶ç©å®¶çŠ¶æ€
```

### 8. ç”¨æˆ·è®¤è¯
```
POST   /api/auth/login
POST   /api/auth/register
POST   /api/auth/logout
```

### 9. å®šæ—¶ä»»åŠ¡
- è‡ªåŠ¨å¤‡ä»½
- å®šæ—¶é‡å¯
- å´©æºƒè‡ªåŠ¨æ¢å¤

### 10. ç³»ç»Ÿç›‘æ§
- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- ç£ç›˜ç©ºé—´

---

## ğŸ”§ æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

### main.go
ç¨‹åºå…¥å£ï¼Œå¯åŠ¨HTTPæœåŠ¡å™¨

### app/model/room.go
æ•°æ®æ¨¡å‹å®šä¹‰ï¼ŒåŒ…æ‹¬ï¼š
- Roomï¼ˆæˆ¿é—´ï¼‰
- WorldConfigï¼ˆä¸–ç•Œé…ç½®ï¼‰
- TShockConfigï¼ˆTShocké…ç½®ï¼‰
- TModLoaderConfigï¼ˆTModLoaderé…ç½®ï¼‰
- Playerï¼ˆç©å®¶ï¼‰

### app/service/room_service.go
ä¸šåŠ¡é€»è¾‘å±‚ï¼ŒåŒ…æ‹¬ï¼š
- CRUDæ“ä½œ
- æœåŠ¡å™¨å¯åŠ¨/åœæ­¢
- è¿›ç¨‹ç®¡ç†
- **TODO: éœ€è¦å®ç°çœŸå®çš„æœåŠ¡å™¨å¯åŠ¨å‘½ä»¤**

### app/controller/room_controller.go
æ§åˆ¶å™¨å±‚ï¼Œå¤„ç†HTTPè¯·æ±‚

### app/router/router.go
è·¯ç”±é…ç½®

---

## ğŸ’¡ ä¸‹ä¸€æ­¥å·¥ä½œ

### ç«‹å³è¦åšçš„ï¼š
1. **å®ç°çœŸå®çš„æœåŠ¡å™¨å¯åŠ¨é€»è¾‘**
   - ç¼–è¾‘ `room_service.go` ä¸­çš„å¯åŠ¨å‡½æ•°
   - é…ç½®æ³°æ‹‰ç‘äºšæœåŠ¡å™¨è·¯å¾„
   - ç¼–å†™å¯åŠ¨å‘½ä»¤

2. **å‰ç«¯å¯¹æ¥æµ‹è¯•**
   - å¯åŠ¨å‰ç«¯ï¼ˆterraria-adminï¼‰
   - å¯åŠ¨åç«¯ï¼ˆterraria-apiï¼‰
   - æµ‹è¯•åˆ›å»ºæˆ¿é—´ã€å¯åŠ¨æœåŠ¡å™¨

3. **å®Œå–„æœåŠ¡å™¨æ§åˆ¶**
   - å®ç°VanillaæœåŠ¡å™¨å¯åŠ¨
   - å®ç°TShockæœåŠ¡å™¨å¯åŠ¨
   - å®ç°TModLoaderæœåŠ¡å™¨å¯åŠ¨

### åç»­æ‰©å±•ï¼š
- æ’ä»¶ç®¡ç†
- Modç®¡ç†
- ç©å®¶ç®¡ç†
- WebSocketå®æ—¶é€šä¿¡
- ç”¨æˆ·è®¤è¯

---

## ğŸ“ æµ‹è¯•API

### åˆ›å»ºTShockæˆ¿é—´
```bash
curl -X POST http://localhost:8080/api/terraria/rooms \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æµ‹è¯•æœåŠ¡å™¨",
    "type": "tshock",
    "port": 7777,
    "maxPlayers": 8,
    "worldName": "TestWorld",
    "worldConfig": {
      "size": "2",
      "difficulty": "1",
      "autoSave": true,
      "pvp": false,
      "motd": "æ¬¢è¿ï¼"
    },
    "tshockConfig": {
      "restApiPort": 7878,
      "restApiToken": "mytoken",
      "superAdminPassword": "admin123"
    }
  }'
```

### å¯åŠ¨æœåŠ¡å™¨
```bash
curl -X POST http://localhost:8080/api/terraria/rooms/1/start
```

---

## ğŸ“ å­¦ä¹ èµ„æº

### Goè¯­è¨€
- [Goå®˜æ–¹æ•™ç¨‹](https://go.dev/tour/)
- [Go By Example](https://gobyexample.com/)

### Ginæ¡†æ¶
- [Ginå®˜æ–¹æ–‡æ¡£](https://gin-gonic.com/zh-cn/docs/)

### GORM
- [GORMä¸­æ–‡æ–‡æ¡£](https://gorm.io/zh_CN/docs/)

### å‚è€ƒé¡¹ç›®
- [é¥¥è’ç®¡ç†å¹³å°DMP](https://github.com/miracleEverywhere/dst-management-platform-api)

---

## âœ… æ£€æŸ¥æ¸…å•

- [x] åˆ›å»ºé¡¹ç›®ç»“æ„
- [x] å®ç°æˆ¿é—´CRUD
- [x] å®ç°æœåŠ¡å™¨æ§åˆ¶
- [x] æ•°æ®åº“é›†æˆ
- [x] ç»Ÿä¸€å“åº”æ ¼å¼
- [x] CORSè·¨åŸŸ
- [x] APIæ–‡æ¡£
- [ ] çœŸå®æœåŠ¡å™¨å¯åŠ¨
- [ ] å‰åç«¯è”è°ƒ
- [ ] æ’ä»¶ç®¡ç†
- [ ] Modç®¡ç†
- [ ] ç©å®¶ç®¡ç†
- [ ] WebSocket
- [ ] ç”¨æˆ·è®¤è¯
- [ ] å®šæ—¶ä»»åŠ¡

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q: Goä¾èµ–ä¸‹è½½å¤ªæ…¢ï¼Ÿ
```bash
# è®¾ç½®å›½å†…ä»£ç†
$env:GOPROXY="https://goproxy.cn,direct"
go mod download
```

### Q: å¦‚ä½•æŸ¥çœ‹æ•°æ®åº“ï¼Ÿ
```bash
# ä½¿ç”¨SQLiteæŸ¥çœ‹å·¥å…·
# æ¨èï¼šDB Browser for SQLite
# ä¸‹è½½ï¼šhttps://sqlitebrowser.org/
```

### Q: ç«¯å£è¢«å ç”¨ï¼Ÿ
```bash
# æ›´æ¢ç«¯å£
go run main.go -p 8081
```

### Q: å¦‚ä½•è°ƒè¯•ï¼Ÿ
```bash
# VS Codeå®‰è£…Goæ’ä»¶
# æˆ–ä½¿ç”¨ Delveè°ƒè¯•å™¨
go install github.com/go-delve/delve/cmd/dlv@latest
dlv debug
```

---

## ğŸ‰ æ€»ç»“

âœ… **åç«¯APIé¡¹ç›®åˆ›å»ºå®Œæˆï¼**

- å®Œæ•´çš„Go+Giné¡¹ç›®ç»“æ„
- æˆ¿é—´ç®¡ç†åŠŸèƒ½
- æœåŠ¡å™¨æ§åˆ¶åŠŸèƒ½
- æ•°æ®åº“é›†æˆ
- å‚è€ƒäº†æˆç†Ÿçš„DMPé¡¹ç›®æ¶æ„

**ä¸‹ä¸€æ­¥**ï¼šå®ç°çœŸå®çš„æœåŠ¡å™¨å¯åŠ¨é€»è¾‘ï¼Œç„¶åå‰åç«¯è”è°ƒï¼

---

**ç¥ä½ å¼€å‘é¡ºåˆ©ï¼ğŸš€**
