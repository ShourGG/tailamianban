import{aA as pe,R as ve,aH as me,S as fe,a8 as _e,J as ye,U as ge,K as he,L as be,ag as xe,P as Ne,ao as ke}from"./ui-vendor-lRdd6BJd.js";import{k as Ce,r as x,c as m,w as Ue,_ as $,R as i,U as d,Q as f,Y as E,V as o,S as c,j as I,I as we,$ as _,F as L,N as O,K as U}from"./vue-vendor-Bom1XEVO.js";const et=[{type:"approval",label:"审批人",icon:"i-mdi:account-check w-4 h-4",iconClass:"approval-icon"},{type:"copy",label:"抄送人",icon:"i-mdi:email-outline w-4 h-4",iconClass:"copy-icon"},{type:"condition",label:"条件分支",icon:"i-mdi:source-branch w-4 h-4",iconClass:"condition-icon"}],Se=[{value:"any",label:"或签",desc:"任意一人同意即可通过"},{value:"all",label:"会签",desc:"所有人都同意才能通过"},{value:"sequence",label:"顺序审批",desc:"按选择顺序依次审批"}],Te=[{label:"申请金额",value:"amount"},{label:"申请人部门",value:"department"},{label:"申请类型",value:"type"},{label:"紧急程度",value:"priority"}],$e=[{label:"等于",value:"equals"},{label:"大于",value:"greater_than"},{label:"小于",value:"less_than"},{label:"包含",value:"contains"},{label:"不等于",value:"not_equals"}],tt={start:"发起人",approval:"审批人",copy:"抄送人",condition:"条件分支"},Ee={approval:"审批人设置",copy:"抄送人设置",condition:"条件分支设置"},st={approvers:"审批人",conditions:"条件配置",connection:"节点连接",copyUsers:"抄送人"},at={required:"必填",incomplete:"不完整",warning:"警告",error:"错误"},ot={id:"start-1",type:"start",position:{x:150,y:100},data:{title:"发起人",status:"active",initiators:[]}},Ie=N=>`https://ui-avatars.com/api/?name=${encodeURIComponent(N)}&background=random`,Le=()=>`condition-${Date.now()}`,lt=(N,w)=>`edge-${N}-${w}`,Oe=()=>({id:Le(),name:"",field:"",operator:"equals",value:""}),Re={key:0,class:"max-h-60vh overflow-y-auto"},Ae={class:"config-section"},De={class:"flex items-center gap-2 mb-4 text-base font-semibold text-gray-800"},Pe={class:"border border-gray-200 rounded-lg p-3 mb-4 bg-gray-50 max-h-50 overflow-y-auto"},Ke={key:0,class:"bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200"},Me={class:"mb-2 text-gray-800 text-sm font-medium"},Be={class:"flex flex-wrap gap-3"},qe={class:"flex items-center gap-2"},Fe={class:"font-medium text-sm"},Ve={class:"text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded"},je={key:0,class:"mt-4"},Ye={class:"flex flex-col gap-1"},ze={class:"text-sm"},Ge={class:"text-xs text-gray-500"},We={key:1,class:"max-h-60vh overflow-y-auto"},He={class:"config-section"},Je={class:"space-y-3"},Qe={class:"flex items-center gap-3 flex-nowrap min-h-10 p-2"},nt=Ce({__name:"NodeConfigModal",props:{show:{type:Boolean,default:!1},currentNode:{default:null},users:{default:()=>[]},departments:{default:()=>[]}},emits:["update:show","save","cancel"],setup(N,{emit:w}){const l=N,y=w,p=pe(),g=x(""),r=x([]),h=x([]),C=x("any"),S=x(!1),b=x([]),R=m({get:()=>l.show,set:e=>y("update:show",e)}),F=m(()=>{if(l.currentNode?.type==="start")return"发起人设置";const e=l.currentNode?.type;return Ee[e]||"节点设置"}),V=m(()=>{const e=[],t=new Map;return l.departments?.forEach(a=>{t.has(a.id)||t.set(a.id,{key:`dept-${a.id}`,label:`${a.name} ${a.manager?`(负责人: ${a.manager})`:""}`,children:[],isLeaf:!1,disabled:!0})}),(l.users?.filter(a=>!g.value||a.name.includes(g.value)||a.department.includes(g.value))||[]).forEach(a=>{const k=l.departments?.find(T=>T.name===a.department);k&&t.has(k.id)&&t.get(k.id).children.push({key:a.id,label:`${a.name}${a.role?`(${a.role})`:""}`,isLeaf:!0,user:a})}),t.forEach(a=>{a.children.length>0&&e.push(a)}),e}),A=m(()=>l.users?.filter(e=>r.value.includes(e.id))||[]),D=m(()=>l.users?.filter(e=>h.value.includes(e.id))||[]),P=m(()=>l.users?.filter(e=>r.value.includes(e.id))||[]),K=e=>{r.value=e.filter(t=>!t.startsWith("dept-"))},j=e=>{h.value=e.filter(t=>!t.startsWith("dept-"))},Y=e=>{r.value=r.value.filter(t=>t!==e)},z=e=>{h.value=h.value.filter(t=>t!==e)},G=e=>{r.value=r.value.filter(t=>t!==e)},W=()=>b.value.push(Oe()),H=e=>b.value.splice(e,1),J=e=>{const{initiators:t}=e.data;r.value=t?t.map(n=>n.id):[]},Q=e=>{const t=e.data.approvers||[];r.value=t.map(n=>n.id),C.value=e.data.approvalMode||"any"},X=e=>{const t=e.data.copyUsers||[];h.value=t.map(n=>n.id)},Z=e=>{b.value=e.data.conditions||[]},ee=async()=>{if(r.value.length===0)return p.error("请选择发起人"),!1;const e=P.value;return y("save",{initiators:e}),p.success(`已设置 ${e.length} 个发起人`),!0},te=async()=>{if(r.value.length===0)return p.error("请至少选择一个审批人"),!1;const e=A.value;return y("save",{approvers:e,approvalMode:C.value}),p.success(`已设置 ${e.length} 个审批人`),!0},se=async()=>{const e=D.value;return y("save",{copyUsers:e}),p.success(`已设置 ${e.length} 个抄送人`),!0},ae=async()=>{if(b.value.length===0)return p.error("请至少添加一个条件分支"),!1;const e=b.value.filter(t=>t.name&&t.field&&t.operator&&t.value);return e.length===0?(p.error("请完善条件配置"),!1):(y("save",{conditions:e}),p.success(`已设置 ${e.length} 个条件分支`),!0)},oe=async()=>{if(!l.currentNode)return!1;S.value=!0;try{const t={start:ee,approval:te,copy:se,condition:ae}[l.currentNode.type];return t?await t():!1}catch{return p.error("保存配置失败"),!1}finally{S.value=!1}},le=()=>{y("cancel")};Ue(()=>l.currentNode,e=>{if(e){g.value="";const n={start:J,approval:Q,copy:X,condition:Z}[e.type];n&&n(e)}},{immediate:!0});const ne=m(()=>["start","approval","copy"].includes(l.currentNode?.type||"")),u=m(()=>{const e=l.currentNode?.type;return e==="start"?{icon:"i-mdi:account-star",title:"选择发起人",checkedKeys:r.value,onSelect:K,selectedUsers:P.value,selectedLabel:"已选择发起人",tagType:"primary",onRemove:G}:e==="approval"?{icon:"i-mdi:account-check",title:"选择审批人",checkedKeys:r.value,onSelect:K,selectedUsers:A.value,selectedLabel:"已选择审批人",tagType:"info",onRemove:Y}:e==="copy"?{icon:"i-mdi:email-outline",title:"选择抄送人",checkedKeys:h.value,onSelect:j,selectedUsers:D.value,selectedLabel:"已选择抄送人",tagType:"success",onRemove:z}:{icon:"",title:"",checkedKeys:[],onSelect:()=>{},selectedUsers:[],selectedLabel:"",tagType:"default",onRemove:()=>{}}});return(e,t)=>{const n=ve,a=me,k=_e,T=fe,re=he,ce=ge,ie=ye,M=xe,B=Ne,ue=be,de=ke;return i(),$(de,{show:R.value,"onUpdate:show":t[2]||(t[2]=s=>R.value=s),style:{width:"900px"},"mask-closable":!1,preset:"dialog",title:F.value,"positive-text":"确定","negative-text":"取消",loading:S.value,onPositiveClick:oe,onNegativeClick:le},{default:d(()=>[ne.value?(i(),f("div",Re,[o("div",Ae,[o("h4",De,[o("div",{class:we([u.value.icon,"w-4 h-4"])},null,2),I(" "+_(u.value.title),1)]),c(n,{value:g.value,"onUpdate:value":t[0]||(t[0]=s=>g.value=s),placeholder:"搜索用户姓名或部门",clearable:"",class:"mb-4"},{prefix:d(()=>[...t[3]||(t[3]=[o("div",{class:"i-mdi:magnify w-4 h-4"},null,-1)])]),_:1},8,["value"]),o("div",Pe,[c(a,{data:V.value,"checked-keys":u.value.checkedKeys,selectable:!1,checkable:"",cascade:"","virtual-scroll":!0,style:{"max-height":"300px"},"onUpdate:checkedKeys":u.value.onSelect},null,8,["data","checked-keys","onUpdate:checkedKeys"])]),u.value.selectedUsers.length>0?(i(),f("div",Ke,[o("h5",Me,_(u.value.selectedLabel)+" ("+_(u.value.selectedUsers.length)+") ",1),o("div",Be,[(i(!0),f(L,null,O(u.value.selectedUsers,s=>(i(),$(T,{key:s.id,closable:"",type:u.value.tagType,onClose:q=>u.value.onRemove(s.id)},{default:d(()=>[o("div",qe,[c(k,{src:s.avatar,"fallback-src":U(Ie)(s.name),size:"small"},null,8,["src","fallback-src"]),o("span",Fe,_(s.name),1),o("span",Ve,_(s.department),1)])]),_:2},1032,["type","onClose"]))),128))])])):E("",!0)]),l.currentNode?.type==="approval"?(i(),f("div",je,[t[4]||(t[4]=o("h5",{class:"mb-3 text-sm font-medium text-gray-800"},"审批模式",-1)),c(ie,{value:C.value,"onUpdate:value":t[1]||(t[1]=s=>C.value=s)},{default:d(()=>[c(ce,{vertical:""},{default:d(()=>[(i(!0),f(L,null,O(U(Se),s=>(i(),$(re,{key:s.value,value:s.value},{default:d(()=>[o("div",Ye,[o("strong",ze,_(s.label),1),o("span",Ge,_(s.desc),1)])]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["value"])])):E("",!0)])):l.currentNode?.type==="condition"?(i(),f("div",We,[o("div",He,[t[8]||(t[8]=o("h4",{class:"flex items-center gap-2 mb-4 text-base font-semibold text-gray-800"},[o("div",{class:"i-mdi:source-branch w-4 h-4"}),I(" 条件分支设置 ")],-1)),o("div",Je,[(i(!0),f(L,null,O(b.value,(s,q)=>(i(),f("div",{key:s.id,class:"condition-item"},[c(ue,{size:"small",class:"border border-gray-200 hover:border-gray-300 transition-colors"},{default:d(()=>[o("div",Qe,[c(n,{value:s.name,"onUpdate:value":v=>s.name=v,placeholder:"分支名称",style:{width:"150px"},class:"flex-shrink-0"},null,8,["value","onUpdate:value"]),c(M,{value:s.field,"onUpdate:value":v=>s.field=v,placeholder:"选择字段",options:U(Te),style:{width:"120px"},class:"flex-shrink-0"},null,8,["value","onUpdate:value","options"]),c(M,{value:s.operator,"onUpdate:value":v=>s.operator=v,placeholder:"操作符",options:U($e),style:{width:"100px"},class:"flex-shrink-0"},null,8,["value","onUpdate:value","options"]),c(n,{value:s.value,"onUpdate:value":v=>s.value=v,placeholder:"值",style:{width:"120px"},class:"flex-shrink-0"},null,8,["value","onUpdate:value"]),c(B,{quaternary:"",type:"error",onClick:v=>H(q),class:"flex-shrink-0 ml-auto"},{icon:d(()=>[...t[5]||(t[5]=[o("div",{class:"i-mdi:delete w-4 h-4"},null,-1)])]),_:1},8,["onClick"])])]),_:2},1024)]))),128)),c(B,{dashed:"",block:"",onClick:W,class:"w-full"},{icon:d(()=>[...t[6]||(t[6]=[o("div",{class:"i-mdi:plus w-4 h-4"},null,-1)])]),default:d(()=>[t[7]||(t[7]=I(" 添加条件 ",-1))]),_:1})])])])):E("",!0)]),_:1},8,["show","title","loading"])}}});export{at as E,st as F,ot as I,et as N,nt as _,tt as a,lt as g};
