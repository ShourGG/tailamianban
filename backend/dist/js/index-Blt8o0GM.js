import{G as R}from"./charts-vendor-PiKWrtPe.js";import{r as C,E as ce,n as X,k as pe,w as H,o as me,Q as I,R as h,Y as $,V as _,S as a,U as l,j as f,K as d,$ as w,a3 as fe,_ as W,F as ve,N as ge}from"./vue-vendor-Bom1XEVO.js";import{e as _e}from"./exportUtils-pIheTlXt.js";import{U as ye,P as be,a3 as ke,W as Ne,ac as Te,ad as he,ae as Ce,R as Ee,af as Ae,L as xe,Y as Fe,X as Pe,ag as ze,ah as Ie,ai as Re}from"./ui-vendor-D9aA433m.js";import{_ as Le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Se={background:{color:"#f5f5f5"},grid:{visible:!0,type:"doubleMesh",args:[{color:"#eee",thickness:1},{color:"#ddd",thickness:1,factor:4}]},mousewheel:{enabled:!0,zoomAtMousePosition:!0,modifiers:"ctrl",minScale:.5,maxScale:2},selecting:{enabled:!0,rubberband:!0,movable:!0,showNodeSelectionBox:!0},resizing:!0,rotating:!0,snapline:!0,keyboard:!0,clipboard:!0};function q(p){return p?{width:p.clientWidth||p.offsetWidth||800,height:p.clientHeight||p.offsetHeight||600}:{width:0,height:0}}function Be(p){const c=C(null),E=C(!1),N=async(k={})=>{await X(),E.value=!0;try{if(!p.value)return;c.value&&(c.value.dispose(),c.value=null);const{width:v,height:s}=q(p.value);if(v===0||s===0){setTimeout(()=>N(k),100);return}const y={container:p.value,width:v,height:s,...Se,...k};c.value=new R(y)}catch{}finally{E.value=!1}};function A(){c.value&&(c.value.dispose(),c.value=null)}function F(){c.value?.centerContent()}function i(){c.value?.zoomToFit({padding:20,maxScale:1})}function L(k){c.value?.zoom(k)}function S(){if(c.value&&p.value){const{width:k,height:v}=q(p.value);c.value.resize(k,v)}}return ce(A),{graph:c,loading:E,initGraph:N,destroyGraph:A,centerContent:F,zoomToFit:i,zoom:L,resizeGraph:S}}const De=[{label:"BIGINT",value:"BIGINT"},{label:"INT",value:"INT"},{label:"SMALLINT",value:"SMALLINT"},{label:"TINYINT",value:"TINYINT"},{label:"VARCHAR(50)",value:"VARCHAR(50)"},{label:"VARCHAR(100)",value:"VARCHAR(100)"},{label:"VARCHAR(255)",value:"VARCHAR(255)"},{label:"CHAR(10)",value:"CHAR(10)"},{label:"TEXT",value:"TEXT"},{label:"LONGTEXT",value:"LONGTEXT"},{label:"DATETIME",value:"DATETIME"},{label:"TIMESTAMP",value:"TIMESTAMP"},{label:"DATE",value:"DATE"},{label:"TIME",value:"TIME"},{label:"DECIMAL(10,2)",value:"DECIMAL(10,2)"},{label:"FLOAT",value:"FLOAT"},{label:"DOUBLE",value:"DOUBLE"},{label:"BOOLEAN",value:"BOOLEAN"},{label:"JSON",value:"JSON"}],Ue=[{label:"导出PNG",key:"png"},{label:"导出SVG",key:"svg"},{label:"导出JSON",key:"json"}],Oe={class:"er-layout"},$e={key:0,class:"toolbar"},we={key:0,style:{"margin-top":"8px"}},Me={class:"table-editor"},Ke={class:"fields-container"},Ve={class:"field-header"},He=pe({__name:"index",props:{data:{},showToolbar:{type:Boolean,default:!0},readonly:{type:Boolean,default:!1}},emits:["ready","data-change"],setup(p,{expose:c,emit:E}){const N=p,A=E,F=C(),{graph:i,initGraph:L,centerContent:S,zoomToFit:k}=Be(F),v=C(!1),s=C(),y=C(!1),G=()=>{y.value=!y.value,!y.value&&i.value&&i.value.getEdges().forEach(t=>{t.attr("line/stroke","#A2B1C3"),t.attr("line/strokeWidth",2)})},P=(t,e)=>t.length>e?t.substring(0,e-1)+"..":t,M=t=>t.fields?.map(e=>{const o=e.isPrimaryKey?`🔑 ${e.name}`:e.isRequired?`* ${e.name}`:e.name;return{id:`${t.id}_${e.name}`,group:"list",attrs:{portNameLabel:{text:P(o,12),title:o},portTypeLabel:{text:P(e.type,10),title:e.type},portBody:{fill:e.isPrimaryKey?"#FFF7E6":"#EFF4FF"}}}})||[],B=t=>({id:t.id,shape:"er-rect",x:t.position.x,y:t.position.y,width:200,height:24+(t.fields?.length||0)*24,data:t,attrs:{label:{text:P(t.name,20),refX:.5,refY:10,textAnchor:"middle",title:t.name}},ports:M(t)}),Y=()=>{i.value&&(R.registerPortLayout("erPortPosition",t=>t.map((e,o)=>({position:{x:0,y:(o+1)*24},angle:0})),!0),R.registerNode("er-rect",{inherit:"rect",markup:[{tagName:"rect",selector:"body"},{tagName:"text",selector:"label"}],attrs:{rect:{strokeWidth:1,stroke:"#5F95FF",fill:"#5F95FF"},label:{fontWeight:"bold",fill:"#ffffff",fontSize:12}},ports:{groups:{list:{markup:[{tagName:"rect",selector:"portBody"},{tagName:"text",selector:"portNameLabel"},{tagName:"text",selector:"portTypeLabel"}],attrs:{portBody:{width:200,height:24,strokeWidth:1,stroke:"#5F95FF",fill:"#EFF4FF",magnet:!0},portNameLabel:{ref:"portBody",refX:6,refY:6,fontSize:9,textAnchor:"start",textOverflow:"ellipsis"},portTypeLabel:{ref:"portBody",refX:120,refY:6,fontSize:9,textAnchor:"start",fill:"#666"}},position:"erPortPosition"}}}},!0))},j=t=>{if(!i.value)return;const e=i.value.createNode(B(t));return i.value.resetCells([e,...i.value.getCells()]),e},J=()=>{const t={id:`table_${Date.now()}`,name:"新表",comment:"",fields:[{name:"id",type:"BIGINT",isPrimaryKey:!0,isRequired:!0,isForeignKey:!1,comment:"主键"},{name:"name",type:"VARCHAR(100)",isPrimaryKey:!1,isRequired:!0,isForeignKey:!1,comment:"名称"}],position:Q()};j(t),K(t),T()},Q=()=>{const t=i.value?.getNodes()||[],e=250;for(let o=0;o<10;o++)for(let n=0;n<3;n++){const r={x:n*e+50,y:o*e+50};if(!t.some(b=>{const g=b.getPosition();return Math.abs(g.x-r.x)<e*.8&&Math.abs(g.y-r.y)<e*.8}))return r}return{x:50,y:50}},K=t=>{s.value={...t,fields:t.fields?.map(e=>({...e}))||[]},v.value=!0},Z=()=>{if(!i.value||!s.value)return;const t=i.value.getCellById(s.value.id);t&&(t.setData(s.value),ee(t,s.value)),v.value=!1,T()},ee=(t,e)=>{t.prop({size:{width:200,height:24+e.fields.length*24},attrs:{label:{text:P(e.name,20),title:e.name}},ports:M(e)})},te=(t,e)=>{e&&(t.isRequired=!0,s.value?.fields.forEach(o=>{o!==t&&(o.isPrimaryKey=!1)}))},oe=()=>{s.value?.fields.push({name:`field_${s.value.fields.length+1}`,type:"VARCHAR(100)",isPrimaryKey:!1,isRequired:!1,isForeignKey:!1,comment:""})},le=t=>{s.value&&s.value.fields.length>1&&s.value.fields.splice(t,1)},D=()=>{if(!i.value)return{tables:[],relations:[]};const t=i.value.getNodes().map(o=>({...o.getData(),position:o.getPosition()})),e=[];return i.value.getEdges().forEach(o=>{const n=o.getSourceNode(),r=o.getTargetNode(),x=o.getSourcePortId(),b=o.getTargetPortId();if(n&&r&&x&&b){const g=x.split("_").slice(1).join("_"),z=b.split("_").slice(1).join("_");e.push({id:o.id,type:"foreign-key",sourceTable:n.id,sourceField:g,targetTable:r.id,targetField:z,name:`${n.getData()?.name||n.id}.${g} -> ${r.getData()?.name||r.id}.${z}`})}}),{tables:t,relations:e}},ae=t=>{if(!i.value)return;const e=D();switch(t){case"png":case"svg":const o=i.value;o.exportPNG&&t==="png"?o.exportPNG("er-diagram"):o.exportSVG&&t==="svg"?o.exportSVG("er-diagram"):o.toDataURL&&o.toDataURL(n=>{const r=document.createElement("a");r.download=`er-diagram.${t}`,r.href=n,r.click()},t);break;case"json":_e(e);break}},T=()=>A("data-change",D());return H(i,t=>{if(t&&t instanceof R){Y(),t.on("node:dblclick",({node:n})=>{N.readonly||K(n.getData())}),t.on("edge:connected",T),t.on("edge:removed",T);let e=null;t.on("edge:click",({edge:n})=>{y.value?(n.remove(),T()):(t.getEdges().forEach(r=>{r.attr("line/stroke","#A2B1C3"),r.attr("line/strokeWidth",2)}),n.attr("line/stroke","#ff4d4f"),n.attr("line/strokeWidth",3),e=n)}),t.on("edge:dblclick",({edge:n})=>{n.remove(),T()}),t.on("blank:click",()=>{e=null,y.value||t.getEdges().forEach(n=>{n.attr("line/stroke","#A2B1C3"),n.attr("line/strokeWidth",2)})});const o=n=>{(n.key==="Delete"||n.key==="Backspace")&&e&&(e.remove(),T(),e=null)};document.addEventListener("keydown",o),t.on("graph:removed",()=>{document.removeEventListener("keydown",o)}),A("ready",t),X(()=>{if(N.data?.tables){const n=N.data.tables.map(r=>t.createNode(B(r)));t.resetCells(n),setTimeout(()=>t.zoomToFit({padding:20,maxScale:1}),300)}})}},{immediate:!0}),H(()=>N.data,t=>{if(i.value&&t?.tables){const e=t.tables.map(o=>i.value.createNode(B(o)));i.value.resetCells(e)}},{deep:!0}),me(()=>L()),c({getGraph:()=>i.value??void 0,getData:D}),(t,e)=>{const o=be,n=ke,r=ye,x=Ne,b=Ee,g=Ce,z=Ae,V=Pe,ne=ze,se=Fe,U=Ie,ie=xe,re=Re,ue=he,de=Te;return h(),I("div",Oe,[p.showToolbar?(h(),I("div",$e,[a(r,null,{default:l(()=>[a(o,{onClick:J,type:"primary",size:"small"},{icon:l(()=>[...e[4]||(e[4]=[_("div",{class:"i-mdi:table-plus"},null,-1)])]),default:l(()=>[e[5]||(e[5]=f(" 添加表 ",-1))]),_:1}),a(o,{onClick:d(S),size:"small"},{icon:l(()=>[...e[6]||(e[6]=[_("div",{class:"i-mdi:image-filter-center-focus"},null,-1)])]),default:l(()=>[e[7]||(e[7]=f(" 居中 ",-1))]),_:1},8,["onClick"]),a(o,{onClick:d(k),size:"small"},{icon:l(()=>[...e[8]||(e[8]=[_("div",{class:"i-mdi:fit-to-screen"},null,-1)])]),default:l(()=>[e[9]||(e[9]=f(" 适应 ",-1))]),_:1},8,["onClick"]),a(o,{onClick:G,type:d(y)?"error":"default",size:"small"},{icon:l(()=>[...e[10]||(e[10]=[_("div",{class:"i-mdi:delete"},null,-1)])]),default:l(()=>[f(" "+w(d(y)?"退出删除":"删除连线"),1)]),_:1},8,["type"]),a(n,{options:d(Ue),onSelect:ae},{default:l(()=>[a(o,{size:"small"},{icon:l(()=>[...e[11]||(e[11]=[_("div",{class:"i-mdi:export"},null,-1)])]),default:l(()=>[e[12]||(e[12]=f(" 导出 ",-1))]),_:1})]),_:1},8,["options"])]),_:1}),d(y)?(h(),I("div",we,[a(x,{type:"info",size:"small","show-icon":!1},{default:l(()=>[...e[13]||(e[13]=[f(" 删除模式：点击连接线即可删除 ",-1)])]),_:1})])):$("",!0)])):$("",!0),_("div",{ref_key:"containerRef",ref:F,class:"graph-container"},null,512),a(de,{show:d(v),"onUpdate:show":e[3]||(e[3]=u=>fe(v)?v.value=u:null),width:"600",placement:"right"},{default:l(()=>[a(ue,{title:`编辑表: ${d(s)?.name||"新表"}`,closable:""},{footer:l(()=>[a(r,{justify:"end"},{default:l(()=>[a(o,{onClick:e[2]||(e[2]=u=>v.value=!1)},{default:l(()=>[...e[21]||(e[21]=[f("取消",-1)])]),_:1}),a(o,{onClick:Z,type:"primary"},{default:l(()=>[...e[22]||(e[22]=[f("保存",-1)])]),_:1})]),_:1})]),default:l(()=>[_("div",Me,[d(s)?(h(),W(re,{key:0,model:d(s),"label-placement":"top"},{default:l(()=>[a(g,{label:"表名"},{default:l(()=>[a(b,{value:d(s).name,"onUpdate:value":e[0]||(e[0]=u=>d(s).name=u),placeholder:"请输入表名"},null,8,["value"])]),_:1}),a(g,{label:"表注释"},{default:l(()=>[a(b,{value:d(s).comment,"onUpdate:value":e[1]||(e[1]=u=>d(s).comment=u),placeholder:"表注释"},null,8,["value"])]),_:1}),a(z,null,{default:l(()=>[...e[14]||(e[14]=[f("字段列表",-1)])]),_:1}),_("div",Ke,[(h(!0),I(ve,null,ge(d(s).fields,(u,O)=>(h(),W(ie,{key:O,size:"small",class:"field-card"},{header:l(()=>[_("div",Ve,[_("span",null,"#"+w(O+1)+" "+w(u.name||"新字段"),1),a(o,{onClick:m=>le(O),size:"tiny",type:"error",quaternary:"",disabled:d(s).fields.length<=1},{default:l(()=>[...e[15]||(e[15]=[f(" 删除 ",-1)])]),_:1},8,["onClick","disabled"])])]),default:l(()=>[a(se,{cols:2,"x-gap":12},{default:l(()=>[a(V,null,{default:l(()=>[a(g,{label:"字段名",size:"small"},{default:l(()=>[a(b,{value:u.name,"onUpdate:value":m=>u.name=m,placeholder:"字段名",size:"small"},null,8,["value","onUpdate:value"])]),_:2},1024)]),_:2},1024),a(V,null,{default:l(()=>[a(g,{label:"类型",size:"small"},{default:l(()=>[a(ne,{value:u.type,"onUpdate:value":m=>u.type=m,options:d(De),size:"small",filterable:"",placeholder:"选择类型"},null,8,["value","onUpdate:value","options"])]),_:2},1024)]),_:2},1024)]),_:2},1024),a(r,{style:{"margin-top":"12px"}},{default:l(()=>[a(U,{checked:u.isPrimaryKey,"onUpdate:checked":[m=>u.isPrimaryKey=m,m=>te(u,m)]},{default:l(()=>[...e[16]||(e[16]=[f(" 主键 ",-1)])]),_:1},8,["checked","onUpdate:checked"]),a(U,{checked:u.isRequired,"onUpdate:checked":m=>u.isRequired=m},{default:l(()=>[...e[17]||(e[17]=[f("必填",-1)])]),_:1},8,["checked","onUpdate:checked"]),a(U,{checked:u.isForeignKey,"onUpdate:checked":m=>u.isForeignKey=m},{default:l(()=>[...e[18]||(e[18]=[f("外键",-1)])]),_:1},8,["checked","onUpdate:checked"])]),_:2},1024),a(g,{label:"注释",size:"small",style:{"margin-top":"12px"}},{default:l(()=>[a(b,{value:u.comment,"onUpdate:value":m=>u.comment=m,placeholder:"字段注释",size:"small"},null,8,["value","onUpdate:value"])]),_:2},1024)]),_:2},1024))),128)),a(o,{onClick:oe,dashed:"",block:"",type:"primary",ghost:"",style:{"margin-top":"16px"}},{icon:l(()=>[...e[19]||(e[19]=[_("div",{class:"i-mdi:plus"},null,-1)])]),default:l(()=>[e[20]||(e[20]=f(" 添加字段 ",-1))]),_:1})])]),_:1},8,["model"])):$("",!0)])]),_:1},8,["title"])]),_:1},8,["show"])])}}}),je=Le(He,[["__scopeId","data-v-fbbd659c"]]);export{je as default};
